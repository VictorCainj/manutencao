<html>
<head>
    <title>Criar Anotação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <style>
        .btn {
            @apply px-4 py-2 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75;
        }
        .btn-blue {
            @apply bg-blue-500 hover:bg-blue-700 focus:ring-blue-400;
        }
        .btn-green {
            @apply bg-green-500 hover:bg-green-700 focus:ring-green-400;
        }
        .btn-yellow {
            @apply bg-yellow-500 hover:bg-yellow-700 focus:ring-yellow-400;
        }
        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-700 focus:ring-gray-400;
        }
        .btn-red {
            @apply bg-red-500 hover:bg-red-700 focus:ring-red-400;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
    <div class="mb-6 space-x-4">
        <button id="createNoteBtn" class="btn btn-blue">
            Criar anotação
        </button>
        <button id="importNotesBtn" class="btn btn-green">
            Importar Contratos
        </button>
        <button id="downloadNotesBtn" class="btn btn-yellow">
            Baixar Todos os Contratos
        </button>
        <input type="file" id="fileInput" class="hidden" accept=".json">
    </div>

    <div class="mb-6 w-full max-w-4xl flex space-x-4">
        <input type="text" id="searchInput" placeholder="Pesquisar contratos..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Modal -->
    <div id="noteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-md shadow-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-center">Criar Anotação</h2>
            <form id="noteForm">
                <div class="mb-4">
                    <label for="contractNumber" class="block text-gray-700">Número de Contrato:</label>
                    <input type="text" id="contractNumber" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="mb-4">
                    <label for="role" class="block text-gray-700">Locador ou Locatário:</label>
                    <input type="text" id="role" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="mb-4">
                    <label for="problem" class="block text-gray-700">Problema:</label>
                    <textarea id="problem" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                </div>
                <div class="mb-4">
                    <label for="date" class="block text-gray-700">Data:</label>
                    <input type="date" id="date" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-gray-700">Endereço:</label>
                    <input type="text" id="address" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancelBtn" class="btn btn-gray mr-2">Cancelar</button>
                    <button type="submit" class="btn btn-blue">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notes Container -->
    <div id="notesContainer" class="w-full max-w-4xl grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- Notes will be appended here -->
    </div>

    <!-- Note Details Modal -->
    <div id="noteDetailsModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-md shadow-lg p-6 w-full max-w-md max-h-full overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4 text-center">Detalhes da Anotação</h2>
            <div id="noteDetailsContent">
                <!-- Note details will be displayed here -->
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold mb-2 text-center">Adicionar Comentário</h3>
                <form id="commentForm">
                    <textarea id="commentText" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 mb-2"></textarea>
                    <button type="submit" class="btn btn-blue">Adicionar</button>
                </form>
            </div>
            <div id="commentsContainer" class="mt-4 space-y-2 max-h-40 overflow-y-auto">
                <!-- Comments will be appended here -->
            </div>
            <div class="flex justify-between mt-4">
                <button type="button" id="copyDetailsBtn" class="btn btn-green">Copiar Dados</button>
                <button type="button" id="downloadContractBtn" class="btn btn-yellow">Baixar Contrato</button>
                <button type="button" id="deleteNoteBtn" class="btn btn-red">Excluir</button>
                <button type="button" id="closeDetailsBtn" class="btn btn-gray">Fechar</button>
            </div>
<!-- Note Details Modal -->
<div id="noteDetailsModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg max-h-screen overflow-y-auto">
        <!-- Header -->
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">Detalhes da Anotação</h2>
            <button id="closeDetailsBtn" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <!-- Anotação Info -->
        <div id="noteDetailsContent" class="space-y-4">
            <!-- Conteúdo gerado dinamicamente -->
        </div>
        <!-- Adicionar Comentário -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Adicionar Comentário</h3>
            <form id="commentForm" class="flex flex-col space-y-3">
                <textarea id="commentText" placeholder="Escreva seu comentário..." 
                          class="w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                <button type="submit" class="btn btn-blue self-end px-6 py-2">Adicionar</button>
            </form>
        </div>
        <!-- Lista de Comentários -->
        <div id="commentsContainer" class="mt-6 space-y-4">
            <!-- Comentários renderizados dinamicamente -->
        </div>
        <!-- Ações -->
        <div class="flex justify-between items-center mt-6">
            <button type="button" id="copyDetailsBtn" class="btn btn-green flex items-center space-x-2">
                <i class="fas fa-copy"></i>
                <span>Copiar Dados</span>
            </button>
            <button type="button" id="downloadContractBtn" class="btn btn-yellow flex items-center space-x-2">
                <i class="fas fa-download"></i>
                <span>Baixar Contrato</span>
            </button>
            <button type="button" id="deleteNoteBtn" class="btn btn-red flex items-center space-x-2">
                <i class="fas fa-trash-alt"></i>
                <span>Excluir</span>
            </button>
        </div>
    </div>
</div>

<script>
    const notes = {};

    // Atualizar cor da nota
    function updateNoteColor(contractNumber, newColor) {
        // Atualiza a cor na estrutura de dados
        if (notes[contractNumber]) {
            notes[contractNumber].color = newColor;
        }

        // Atualiza a cor no botão correspondente
        const noteButton = Array.from(document.querySelectorAll('.note-button')).find(
            (button) => button.querySelector('span').textContent.slice(1) === contractNumber
        );

        if (noteButton) {
            noteButton.className = `note-button w-full px-4 py-2 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 ${newColor}`;
        }
    }

    // Adiciona os botões de cor no modal de detalhes
    function setupColorButtons(contractNumber) {
        const colorButtonsContainer = document.createElement('div');
        colorButtonsContainer.className = 'flex justify-center gap-2 mt-4';

        const colors = {
            'bg-red-500': 'Vermelho (Prioridade)',
            'bg-blue-500': 'Azul (Padrão)',
        };

        Object.entries(colors).forEach(([colorClass, label]) => {
            const button = document.createElement('button');
            button.className = `px-4 py-2 rounded-md shadow-md text-white ${colorClass}`;
            button.textContent = label;

            button.addEventListener('click', () => {
                updateNoteColor(contractNumber, colorClass);
            });

            colorButtonsContainer.appendChild(button);
        });

        return colorButtonsContainer;
    }

    document.getElementById('noteForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const contractNumber = document.getElementById('contractNumber').value;
        const role = document.getElementById('role').value;
        const problem = document.getElementById('problem').value;
        const date = document.getElementById('date').value;
        const address = document.getElementById('address').value;

        const noteButton = document.createElement('button');
        const defaultColor = 'bg-blue-500';
        noteButton.className = `note-button w-full px-4 py-2 text-white rounded-md shadow-md hover:${defaultColor} ${defaultColor}`;
        noteButton.innerHTML = `<span class="block font-bold">#${contractNumber}</span><span class="block text-sm">${role}</span>`;
        noteButton.addEventListener('click', function () {
            const formattedDate = new Date(date).toLocaleDateString('pt-BR');
            document.getElementById('noteDetailsContent').innerHTML = `
                <h3 class="text-lg font-semibold text-center">#${contractNumber}</h3>
                <p><strong>Locador ou Locatário:</strong> ${role}</p>
                <p><strong>Problema:</strong> ${problem}</p>
                <p><strong>Data:</strong> ${formattedDate}</p>
                <p><strong>Endereço:</strong> ${address}</p>
            `;

            const buttonsContainer = setupColorButtons(contractNumber);
            document.getElementById('noteDetailsContent').appendChild(buttonsContainer);

            document.getElementById('noteDetailsModal').classList.remove('hidden');
        });

        document.getElementById('notesContainer').appendChild(noteButton);

        notes[contractNumber] = {
            role,
            problem,
            date,
            address,
            color: defaultColor,
            comments: [],
        };

        document.getElementById('noteForm').reset();
        document.getElementById('noteModal').classList.add('hidden');
    });

    document.getElementById('downloadNotesBtn').addEventListener('click', function () {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "contratos.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });

    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const importedNotes = JSON.parse(e.target.result);
                for (const contractNumber in importedNotes) {
                    if (importedNotes.hasOwnProperty(contractNumber)) {
                        const note = importedNotes[contractNumber];
                        notes[contractNumber] = note;

                        const noteButton = document.createElement('button');
                        noteButton.className = `note-button w-full px-4 py-2 text-white rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 ${note.color || 'bg-blue-500'}`;
                        noteButton.innerHTML = `<span class="block font-bold">#${contractNumber}</span><span class="block text-sm">${note.role}</span>`;
                        noteButton.addEventListener('click', function () {
                            const formattedDate = new Date(note.date).toLocaleDateString('pt-BR');
                            document.getElementById('noteDetailsContent').innerHTML = `
                                <h3 class="text-lg font-semibold text-center">#${contractNumber}</h3>
                                <p><strong>Locador ou Locatário:</strong> ${note.role}</p>
                                <p><strong>Problema:</strong> ${note.problem}</p>
                                <p><strong>Data:</strong> ${formattedDate}</p>
                                <p><strong>Endereço:</strong> ${note.address}</p>
                            `;

                            const buttonsContainer = setupColorButtons(contractNumber);
                            document.getElementById('noteDetailsContent').appendChild(buttonsContainer);

                            document.getElementById('noteDetailsModal').classList.remove('hidden');
                        });

                        document.getElementById('notesContainer').appendChild(noteButton);
                    }
                }
            };
            reader.readAsText(file);
        }
    });
</script>


        document.getElementById('downloadNotesBtn').addEventListener('click', function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "contratos.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        document.getElementById('searchInput').addEventListener('input', filterNotes);

        function filterNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const noteButtons = document.querySelectorAll('.note-button');
            noteButtons.forEach(button => {
                const contractNumber = button.textContent.toLowerCase();
                const role = button.dataset.role;
                const address = button.dataset.address;
                const matchesSearch = contractNumber.includes(searchTerm) || role.includes(searchTerm) || address.includes(searchTerm);
                if (matchesSearch) {
                    button.classList.remove('hidden');
                } else {
                    button.classList.add('hidden');
                }
            });
        }

        document.getElementById('deleteNoteBtn').addEventListener('click', function () {
    const contractNumber = document.getElementById('noteDetailsContent')
        .querySelector('h3')
        .textContent.slice(1);

    // Remover a anotação do objeto 'notes'
    if (notes[contractNumber]) {
        delete notes[contractNumber];
    }

    // Encontrar e remover o botão correspondente à anotação
    const noteButton = Array.from(document.querySelectorAll('.note-button')).find(
        (button) => button.querySelector('span').textContent.slice(1) === contractNumber
    );
    if (noteButton) {
        noteButton.remove();
    }

    // Fechar o modal de detalhes
    document.getElementById('noteDetailsModal').classList.add('hidden');
});
</script>
</body>
</html>
