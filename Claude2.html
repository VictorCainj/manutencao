<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Anotações de Contratos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        .btn {
            @apply px-4 py-2 rounded-md transition-colors duration-200 flex items-center justify-center;
        }
        
        .btn-blue {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        
        .btn-green {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        
        .btn-yellow {
            @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
        
        .btn-red {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        
        .btn-gray {
            @apply bg-gray-500 text-white hover:bg-gray-600;
        }

        .note-card {
            @apply bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer border border-gray-200;
            @apply h-40 flex flex-col justify-between;
        }

        .comment-box {
            @apply bg-gray-50 p-4 rounded-lg mb-4;
        }

        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
        }

        .modal-content {
            @apply bg-white rounded-lg shadow-xl max-h-[90vh] overflow-y-auto;
        }

        .notification {
            @apply fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-md text-white z-50 transition-all duration-300;
        }

        .notification-success {
            @apply bg-green-500;
        }

        .notification-error {
            @apply bg-red-500;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <!-- Container Principal -->
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Sistema de Anotações de Contratos</h1>
        
        <!-- Barra de Ferramentas -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="createNoteBtn" class="btn btn-blue">
                <i class="fas fa-plus mr-2"></i>Nova Anotação
            </button>
            <button id="importNotesBtn" class="btn btn-green">
                <i class="fas fa-file-import mr-2"></i>Importar
            </button>
            <button id="downloadNotesBtn" class="btn btn-yellow">
                <i class="fas fa-download mr-2"></i>Exportar Todos
            </button>
        </div>

        <!-- Barra de Busca e Filtros -->
        <div class="mb-6">
            <input type="text" 
                   id="searchInput" 
                   placeholder="Pesquisar contratos..." 
                   class="w-full p-2 border rounded mb-2">
            <div class="flex gap-4">
                <select id="dateSort" class="p-2 border rounded">
                    <option value="newest">Mais recentes</option>
                    <option value="oldest">Mais antigos</option>
                </select>
                <select id="statusFilter" class="p-2 border rounded">
                    <option value="all">Todos os status</option>
                    <option value="open">Abertos</option>
                    <option value="scheduled">Agendados</option>
                    <option value="closed">Fechados</option>
                </select>
            </div>
        </div>

        <!-- Detalhes da Anotação -->
        <div id="noteDetailsContainer" class="mb-6 hidden">
            <!-- Detalhes da anotação serão inseridos aqui dinamicamente -->
        </div>

        <!-- Container de Notas -->
        <div id="notesContainer" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- As notas serão inseridas aqui dinamicamente -->
        </div>

        <!-- Modal de Nova Anotação -->
        <div id="noteModal" class="modal-overlay hidden">
            <div class="modal-content p-6 w-full max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-center">Nova Anotação</h2>
                <form id="noteForm" class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="contractNumber" class="block text-gray-700 mb-2"><b>Número do Contrato*</b></label>
                            <input type="text" 
                                   id="contractNumber" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   required
                                   placeholder="Ex: CT12345">
                        </div>
                        <div>
                            <label for="creationDate" class="block text-gray-700 mb-2"><b>Data de Criação*</b></label>
                            <input type="date" 
                                   id="creationDate" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   required>
                        </div>
                        <div>
                            <label for="locator" class="block text-gray-700 mb-2"><b>Locador*</b></label>
                            <input type="text" 
                                   id="locator" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   required
                                   placeholder="Nome do locador">
                        </div>
                        <div>
                            <label for="tenant" class="block text-gray-700 mb-2"><b>Locatário*</b></label>
                            <input type="text" 
                                   id="tenant" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   required
                                   placeholder="Nome do locatário">
                        </div>
                        <div>
                            <label for="address" class="block text-gray-700 mb-2"><b>Endereço*</b></label>
                            <input type="text" 
                                   id="address" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   required
                                   placeholder="Endereço completo">
                        </div>
                        <div>
                            <label for="problem" class="block text-gray-700 mb-2"><b>Problema*</b></label>
                            <textarea id="problem" 
                                      class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[100px]"
                                      required
                                      placeholder="Descreva o problema"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-center space-x-2 mt-6">
                        <button type="button" 
                                id="cancelBtn"
                                class="btn btn-gray">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit" 
                                class="btn btn-blue">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Detalhes -->
        <div id="noteDetailsModal" class="modal-overlay hidden">
            <!-- O conteúdo será inserido dinamicamente -->
        </div>

        <!-- Input file oculto para importação -->
        <input type="file" id="fileInput" class="hidden" accept=".json">

        <!-- Notificação -->
        <div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 hidden"></div>
    </div>

    <script>
        // Utilitários
        const utils = {
            formatDate: (date, includeTime = false) => {
                if (!date) return '';
                const d = new Date(date);
                if (isNaN(d.getTime())) return '';
                
                const pad = (num) => String(num).padStart(2, '0');
                const dateStr = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
                
                if (!includeTime) return dateStr;
                return `${dateStr} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            },

            showNotification: (message, type = 'success') => {
                const notification = document.getElementById('notification');
                if (!notification) return;

                notification.textContent = message;
                notification.className = `notification ${type === 'success' ? 'notification-success' : 'notification-error'}`;
                notification.classList.remove('hidden');

                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            },

            sanitizeInput: (text) => {
                if (!text) return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
        };

        // Classe principal de gerenciamento de notas
        class NoteManager {
            constructor() {
                if (window.noteManager) {
                    return window.noteManager;
                }

                this.notes = {};
                this.activeNoteKey = null;
                this.initialize();
                window.noteManager = this;
            }

            initialize() {
                this.loadFromLocalStorage();
                this.initializeEventListeners();
                this.renderAllNotes();
            }

            initializeEventListeners() {
                // Botão de nova anotação
                document.getElementById('createNoteBtn')?.addEventListener('click', () => {
                    const modal = document.getElementById('noteModal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        document.getElementById('noteForm')?.reset();
                    }
                });

                // Formulário de nova anotação
                document.getElementById('noteForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = {
                        contractNumber: document.getElementById('contractNumber').value.trim(),
                        createdAt: document.getElementById('creationDate').value,
                        locator: document.getElementById('locator').value.trim(),
                        tenant: document.getElementById('tenant').value.trim(),
                        address: document.getElementById('address').value.trim(),
                        problem: document.getElementById('problem').value.trim()
                    };

                    if (this.addNote(formData)) {
                        document.getElementById('noteModal').classList.add('hidden');
                        document.getElementById('noteForm').reset();
                    }
                });

                // Botão de cancelar nova anotação
                document.getElementById('cancelBtn')?.addEventListener('click', () => {
                    document.getElementById('noteModal').classList.add('hidden');
                    document.getElementById('noteForm').reset();
                });

                // Botão de exportar todos
                document.getElementById('downloadNotesBtn')?.addEventListener('click', () => {
                    this.exportAllNotes();
                });

                // Input de importação
                const fileInput = document.getElementById('fileInput');
                document.getElementById('importNotesBtn')?.addEventListener('click', () => {
                    fileInput?.click();
                });

                fileInput?.addEventListener('change', (e) => {
                    this.handleFileImport(e);
                });

                // Filtros e busca
                ['statusFilter', 'dateSort', 'searchInput'].forEach(id => {
                    document.getElementById(id)?.addEventListener('change', () => {
                        this.filterAndSortNotes();
                    });
                });

                document.getElementById('searchInput')?.addEventListener('input', () => {
                    this.filterAndSortNotes();
                });

                // Fechar modais com ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.getElementById('noteModal')?.classList.add('hidden');
                        document.getElementById('noteDetailsModal')?.classList.add('hidden');
                        document.getElementById('noteDetailsContainer')?.classList.add('hidden');
                    }
                });
            }

            loadFromLocalStorage() {
                try {
                    const savedNotes = localStorage.getItem('notes');
                    this.notes = savedNotes ? JSON.parse(savedNotes) : {};
                } catch (error) {
                    console.error('Erro ao carregar notas:', error);
                    this.notes = {};
                }
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('notes', JSON.stringify(this.notes));
                } catch (error) {
                    utils.showNotification('Erro ao salvar notas. Verifique o espaço disponível.', 'error');
                }
            }

            renderAllNotes() {
                const container = document.getElementById('notesContainer');
                if (!container) return;

                container.innerHTML = '';
                
                if (Object.keys(this.notes).length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center text-gray-500 py-8">
                            Nenhuma anotação encontrada. Clique em "Nova Anotação" para começar!
                        </div>
                    `;
                    return;
                }

                // Ordenar notas por data de criação (mais recentes primeiro)
                const sortedNotes = Object.entries(this.notes)
                    .sort(([, a], [, b]) => new Date(b.createdAt) - new Date(a.createdAt));

                sortedNotes.forEach(([key, note]) => {
                    this.renderNote(key);
                });
            }

            renderNote(noteKey) {
                const note = this.notes[noteKey];
                if (!note) return;

                const container = document.getElementById('notesContainer');
                if (!container) return;

                const noteElement = document.createElement('div');
                noteElement.className = 'note-card';
                noteElement.setAttribute('data-note-key', noteKey);

                const statusColors = {
                    'open': 'text-blue-600',
                    'scheduled': 'text-orange-600',
                    'closed': 'text-green-600'
                };

                const statusIcons = {
                    'open': 'fa-folder-open',
                    'scheduled': 'fa-calendar-alt',
                    'closed': 'fa-check-circle'
                };

                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-lg">${utils.sanitizeInput(note.contractNumber)}</h3>
                        <i class="fas ${statusIcons[note.status]} ${statusColors[note.status]}"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="text-sm text-gray-600 mb-1">${utils.sanitizeInput(note.locator)}</p>
                        <p class="text-sm text-gray-600 mb-1">${utils.sanitizeInput(note.tenant)}</p>
                        <p class="text-sm text-gray-500 truncate">${utils.sanitizeInput(note.address)}</p>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        ${utils.formatDate(note.createdAt)}
                    </div>
                `;

                noteElement.addEventListener('click', () => this.showNoteDetails(noteKey));
                container.appendChild(noteElement);
            }

            addNote(formData) {
                const noteKey = `#${formData.contractNumber}`;
                
                if (this.notes[noteKey]) {
                    utils.showNotification('Já existe uma anotação com este número de contrato.', 'error');
                    return false;
                }

                this.notes[noteKey] = {
                    ...formData,
                    status: 'open',
                    comments: [],
                    createdAt: new Date().toISOString(),
                    closedAt: null
                };

                this.saveToLocalStorage();
                this.renderNote(noteKey);
                utils.showNotification('Anotação criada com sucesso!', 'success');
                return true;
            }

            showNoteDetails(noteKey) {
                const note = this.notes[noteKey];
                if (!note) return;

                const modal = document.getElementById('noteDetailsModal');
                const detailsContainer = document.getElementById('noteDetailsContainer');
                if (!modal || !detailsContainer) return;

                this.activeNoteKey = noteKey;

                const statusText = {
                    'open': 'Aberto',
                    'scheduled': 'Agendado',
                    'closed': 'Finalizado'
                };

                const detailsHTML = `
                    <div class="modal-content p-6 w-full max-w-4xl mx-auto mt-20">
                        <div class="flex justify-between items-start mb-6">
                            <h2 class="text-2xl font-semibold">Detalhes da Anotação</h2>
                            <button id="closeDetailsBtn" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 class="font-semibold mb-2"><b>Contrato:</b> ${utils.sanitizeInput(note.contractNumber)}</h3>
                                <p class="text-gray-600"><b>Status:</b> <span class="font-semibold">${statusText[note.status]}</span></p>
                                <p class="text-gray-600"><b>Criado em:</b> ${utils.formatDate(note.createdAt, true)}</p>
                                ${note.closedAt ? `<p class="text-gray-600"><b>Fechado em:</b> ${utils.formatDate(note.closedAt, true)}</p>` : ''}
                            </div>

<div class="space-y-2">
    <p><b>Locador:</b> ${utils.sanitizeInput(note.locator)}</p>
    <p><b>Locatário:</b> ${utils.sanitizeInput(note.tenant)}</p>
    <p><b>Endereço:</b> ${utils.sanitizeInput(note.address)}</p>
</div>

<div class="col-span-full">
    <p class="font-semibold mb-2"><b>Problema:</b></p>
    <p class="whitespace-pre-wrap bg-gray-50 p-4 rounded-lg">
        ${utils.sanitizeInput(note.problem)}
    </p>
</div>

<!-- Botões de Ação -->
<div class="flex flex-wrap gap-2 mb-6">
    ${this.generateStatusButtons(note.status)}
    <button id="copyDetailsBtn" class="btn btn-gray">
        <i class="fas fa-copy mr-2"></i>Copiar Detalhes
    </button>
    <button id="downloadContractBtn" class="btn btn-blue">
        <i class="fas fa-download mr-2"></i>Exportar
    </button>
    <button id="deleteNoteBtn" class="btn btn-red">
        <i class="fas fa-trash mr-2"></i>Excluir
    </button>
</div>

<!-- Seção de Agendamento -->
${note.status === 'scheduled' ? this.generateSchedulingSection(note) : ''}

<!-- Seção de Comentários -->
<div class="border-t pt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
        <h3 class="text-lg font-semibold mb-4">Comentários</h3>
        <form id="commentForm" class="mb-4">
            <textarea id="commentText" 
                      class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[80px]"
                      placeholder="Adicione um comentário..."></textarea>
            <div class="flex justify-end mt-2">
                <button type="submit" class="btn btn-blue">
                    <i class="fas fa-comment mr-2"></i>Comentar
                </button>
            </div>
        </form>
        <div id="commentsContainer" class="space-y-4">
            <!-- Comentários serão renderizados aqui -->
        </div>
    </div>
</div>
</div>
</div>
`;

detailsContainer.innerHTML = detailsHTML;
detailsContainer.classList.remove('hidden');
modal.classList.add('hidden');
this.setupDetailsEventListeners(noteKey);
this.renderComments(noteKey);
}

generateStatusButtons(currentStatus) {
    const buttons = [
        { status: 'open', text: 'Reabrir', icon: 'folder-open', color: 'blue' },
        { status: 'scheduled', text: 'Agendar', icon: 'calendar-alt', color: 'orange' },
        { status: 'closed', text: 'Finalizar', icon: 'check-circle', color: 'green' }
    ];

    return buttons
        .filter(btn => btn.status !== currentStatus)
        .map(btn => `
            <button class="btn btn-${btn.color} status-btn" data-status="${btn.status}">
                <i class="fas fa-${btn.icon} mr-2"></i>${btn.text}
            </button>
        `).join('');
}

generateSchedulingSection(note) {
    return `
        <div id="schedulingContainer" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold mb-3">Informações de Agendamento</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-2">Data do Agendamento</label>
                    <input type="date" 
                           id="scheduleDate" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           value="${note.scheduleDate || ''}">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Prestador de Serviço</label>
                    <input type="text" 
                           id="serviceProvider" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           value="${note.serviceProvider || ''}"
                           placeholder="Nome do prestador">
                </div>
            </div>
        </div>
    `;
}

updateNoteStatus(noteKey, newStatus) {
    const note = this.notes[noteKey];
    if (!note) return;

    // Remove a nota antiga antes de atualizar o status
    const noteElement = document.querySelector(`[data-note-key="${noteKey}"]`);
    if (noteElement) {
        noteElement.remove();
    }

    note.status = newStatus;

    switch (newStatus) {
        case 'open':
            note.scheduleDate = null;
            note.serviceProvider = null;
            note.closedAt = null;
            break;

        case 'scheduled':
            note.closedAt = null;
            if (!note.scheduleDate) {
                note.scheduleDate = '';
            }
            if (!note.serviceProvider) {
                note.serviceProvider = '';
            }
            break;

        case 'closed':
            note.closedAt = new Date().toISOString();
            break;
    }

    this.saveToLocalStorage();
    this.renderNote(noteKey);
    this.showNoteDetails(noteKey);

    const statusMessages = {
        'open': 'Anotação reaberta com sucesso!',
        'scheduled': 'Anotação movida para agendamento!',
        'closed': 'Anotação finalizada com sucesso!'
    };

    utils.showNotification(statusMessages[newStatus], 'success');
}

updateSchedulingInfo(noteKey, scheduleDate, serviceProvider) {
    const note = this.notes[noteKey];
    if (!note || note.status !== 'scheduled') return;

    note.scheduleDate = scheduleDate;
    note.serviceProvider = serviceProvider;

    this.saveToLocalStorage();
    this.renderNote(noteKey);

    utils.showNotification('Informações de agendamento atualizadas!', 'success');
}

filterAndSortNotes() {
    const statusFilter = document.getElementById('statusFilter')?.value;
    const dateSort = document.getElementById('dateSort')?.value;
    const searchQuery = document.getElementById('searchInput')?.value.toLowerCase();

    const container = document.getElementById('notesContainer');
    if (!container) return;

    container.innerHTML = '';

    let filteredNotes = Object.entries(this.notes);

    // Aplicar filtro de status
    if (statusFilter && statusFilter !== 'all') {
        filteredNotes = filteredNotes.filter(([, note]) => note.status === statusFilter);
    }

    // Aplicar filtro de busca
    if (searchQuery) {
        filteredNotes = filteredNotes.filter(([, note]) => {
            const searchFields = [
                note.contractNumber,
                note.locator,
                note.tenant,
                note.address,
                note.problem
            ];
            return searchFields.some(field => 
                field?.toLowerCase().includes(searchQuery)
            );
        });
    }

    // Ordenar por data
    filteredNotes.sort(([, a], [, b]) => {
        const dateA = new Date(a.createdAt);
        const dateB = new Date(b.createdAt);
        return dateSort === 'newest' 
            ? dateB - dateA 
            : dateA - dateB;
    });

    if (filteredNotes.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center text-gray-500 py-8">
                Nenhuma anotação encontrada com os filtros atuais.
            </div>
        `;
        return;
    }

    filteredNotes.forEach(([key]) => {
        this.renderNote(key);
    });
}

setupDetailsEventListeners(noteKey) {
    const detailsContainer = document.getElementById('noteDetailsContainer');
    const note = this.notes[noteKey];

    // Fechar detalhes
    document.getElementById('closeDetailsBtn')?.addEventListener('click', () => {
        detailsContainer.classList.add('hidden');
        this.activeNoteKey = null;
    });

    // Botões de status
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            this.updateNoteStatus(noteKey, btn.dataset.status);
        });
    });

    // Formulário de comentários
    document.getElementById('commentForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        this.addComment(noteKey);
    });

    // Confirmar comentários com Enter
    document.getElementById('commentText')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('commentForm')?.requestSubmit();
        }
    });

    // Copiar detalhes
    document.getElementById('copyDetailsBtn')?.addEventListener('click', () => {
        this.copyNoteDetails(noteKey);
    });

    // Exportar nota
    document.getElementById('downloadContractBtn')?.addEventListener('click', () => {
        this.exportNote(noteKey);
    });

    // Excluir nota
    document.getElementById('deleteNoteBtn')?.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja excluir esta anotação?')) {
            delete this.notes[noteKey];
            this.saveToLocalStorage();
            detailsContainer.classList.add('hidden');
            this.renderAllNotes();
            utils.showNotification('Anotação excluída com sucesso!', 'success');
        }
    });

    // Atualizar informações de agendamento
    if (note.status === 'scheduled') {
        const scheduleDate = document.getElementById('scheduleDate');
        const serviceProvider = document.getElementById('serviceProvider');

        const updateScheduling = () => {
            this.updateSchedulingInfo(noteKey, 
                scheduleDate.value,
                serviceProvider.value.trim()
            );
        };

        scheduleDate?.addEventListener('change', updateScheduling);
        serviceProvider?.addEventListener('blur', updateScheduling);
    }
}

addComment(noteKey) {
    const commentText = document.getElementById('commentText')?.value.trim();
    if (!commentText) {
        utils.showNotification('O comentário não pode estar vazio.', 'error');
        return;
    }

    const note = this.notes[noteKey];
    if (!note.comments) note.comments = [];

    const newComment = {
        id: Date.now().toString(),
        text: commentText,
        dateTime: new Date().toISOString(),
        editedAt: null
    };

    note.comments.push(newComment);
    this.saveToLocalStorage();
    this.renderComments(noteKey);

    document.getElementById('commentForm')?.reset();
    utils.showNotification('Comentário adicionado com sucesso!', 'success');
}

renderComments(noteKey) {
    const container = document.getElementById('commentsContainer');
    const note = this.notes[noteKey];
    
    if (!container || !note) return;

    container.innerHTML = '';

    if (!note.comments || note.comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                Nenhum comentário ainda. Seja o primeiro a comentar!
            </div>
        `;
        return;
    }

    note.comments.slice().reverse().forEach(comment => {
        const commentElement = this.createCommentElement(comment, noteKey);
        container.appendChild(commentElement);
    });
}

createCommentElement(comment, noteKey) {
    const div = document.createElement('div');
    div.className = 'comment-box';
    div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <div class="text-xs text-gray-500">
                ${utils.formatDate(comment.dateTime, true)}
                ${comment.editedAt ? ' (editado)' : ''}
            </div>
            <div class="flex space-x-2">
                <button class="text-blue-500 hover:text-blue-700 edit-comment-btn" 
                        data-comment-id="${comment.id}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-500 hover:text-red-700 delete-comment-btn" 
                        data-comment-id="${comment.id}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="comment-text whitespace-pre-wrap">${utils.sanitizeInput(comment.text)}</div>
        <div class="edit-form hidden mt-2">
            <textarea class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">${comment.text}</textarea>
            <div class="flex justify-end space-x-2 mt-2">
                <button class="btn btn-gray cancel-edit-btn">Cancelar</button>
                <button class="btn btn-blue save-edit-btn">Salvar</button>
            </div>
        </div>
    `;

    this.setupCommentEventListeners(div, noteKey, comment.id);
    return div;
}

setupCommentEventListeners(commentElement, noteKey, commentId) {
    const editBtn = commentElement.querySelector('.edit-comment-btn');
    const deleteBtn = commentElement.querySelector('.delete-comment-btn');
    const editForm = commentElement.querySelector('.edit-form');
    const commentText = commentElement.querySelector('.comment-text');
    const cancelEditBtn = commentElement.querySelector('.cancel-edit-btn');
    const saveEditBtn = commentElement.querySelector('.save-edit-btn');

    editBtn?.addEventListener('click', () => {
        editForm.classList.remove('hidden');
        commentText.classList.add('hidden');
    });

    cancelEditBtn?.addEventListener('click', () => {
        editForm.classList.add('hidden');
        commentText.classList.remove('hidden');
    });

    saveEditBtn?.addEventListener('click', () => {
        const newText = editForm.querySelector('textarea').value.trim();
        if (newText) {
            this.editComment(noteKey, commentId, newText);
        }
    });

    deleteBtn?.addEventListener('click', () => {
        this.deleteComment(noteKey, commentId);
    });
}

editComment(noteKey, commentId, newText) {
    const note = this.notes[noteKey];
    const comment = note.comments.find(c => c.id === commentId);
    
    if (comment && newText !== comment.text) {
        comment.text = newText;
        comment.editedAt = new Date().toISOString();
        this.saveToLocalStorage();
        this.renderComments(noteKey);
        utils.showNotification('Comentário atualizado com sucesso!', 'success');
    }
}

deleteComment(noteKey, commentId) {
    if (!confirm('Tem certeza que deseja excluir este comentário?')) {
        return;
    }

    const note = this.notes[noteKey];
    const commentIndex = note.comments.findIndex(c => c.id === commentId);
    
    if (commentIndex !== -1) {
        note.comments.splice(commentIndex, 1);
        this.saveToLocalStorage();
        this.renderComments(noteKey);
        utils.showNotification('Comentário excluído com sucesso!', 'success');
    }
}

copyNoteDetails(noteKey) {
    const note = this.notes[noteKey];
    if (!note) return;

    const details = `
Contrato: ${note.contractNumber}
Data: ${utils.formatDate(note.createdAt)}
Locador: ${note.locator}
Locatário: ${note.tenant}
Endereço: ${note.address}
Problema: ${note.problem}
Status: ${note.status}
${note.scheduleDate ? `Data Agendada: ${utils.formatDate(note.scheduleDate)}` : ''}
${note.serviceProvider ? `Prestador: ${note.serviceProvider}` : ''}
    `.trim();

    navigator.clipboard.writeText(details)
        .then(() => utils.showNotification('Detalhes copiados para a área de transferência!', 'success'))
        .catch(() => utils.showNotification('Erro ao copiar detalhes.', 'error'));
}

exportNote(noteKey) {
    const note = this.notes[noteKey];
    if (!note) return;

    const dataStr = JSON.stringify({ [noteKey]: note }, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `contrato_${note.contractNumber}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    utils.showNotification('Contrato exportado com sucesso!', 'success');
}

exportAllNotes() {
    const dataStr = JSON.stringify(this.notes, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `contratos_export_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    utils.showNotification('Dados exportados com sucesso!', 'success');
}

handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            let importCount = 0;
            let skipCount = 0;

            for (const [key, note] of Object.entries(importedData)) {
                if (this.notes[key]) {
                    skipCount++;
                    continue;
                }

                if (this.validateImportedNote(note)) {
                    this.notes[key] = note;
                    this.renderNote(key);
                    importCount++;
                } else {
                    skipCount++;
                }
            }

            this.saveToLocalStorage();
            utils.showNotification(
                `Importação concluída! ${importCount} notas importadas, ${skipCount} ignoradas.`,
                'success'
            );
        } catch (error) {
            utils.showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
        }
    };

    reader.onerror = () => {
        utils.showNotification('Erro ao ler arquivo.', 'error');
    };

    reader.readAsText(file);
    event.target.value = '';
}

validateImportedNote(note) {
    const requiredFields = [
        'contractNumber',
        'locator',
        'tenant',
        'problem',
        'address',
        'createdAt',
        'status'
    ];

    return requiredFields.every(field => 
        note.hasOwnProperty(field) && 
        note[field] !== null && 
        note[field] !== undefined
    ) && ['open', 'scheduled', 'closed'].includes(note.status);
}
}

// Inicialização da aplicação
document.addEventListener('DOMContentLoaded', () => {
    window.noteManager = new NoteManager();
});
</script>
</body>
</html>
