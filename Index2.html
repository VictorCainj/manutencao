<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Anotações de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .btn {
            @apply px-4 py-2 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-colors duration-200;
        }
        .btn-wine-red {
            @apply bg-red-900 hover:bg-red-700 focus:ring-red-400;
        }
        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-700 focus:ring-gray-400;
        }
        .btn-green {
            @apply bg-green-500 hover:bg-green-700 focus:ring-green-400;
        }
        .btn-yellow {
            @apply bg-yellow-500 hover:bg-yellow-700 focus:ring-yellow-400;
        }
        .notification {
            @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 rounded-md shadow-lg transition-all duration-300 ease-in-out z-50 font-semibold text-center;
            animation: slideIn 0.3s ease-out;
        }
        .notification-success {
            @apply bg-green-500 text-white border-l-4 border-green-700;
        }
        .notification-error {
            @apply bg-red-500 text-white border-l-4 border-red-700;
        }
        .notification-alert {
            @apply bg-yellow-500 text-black border-l-4 border-yellow-700;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 z-40;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-lg transform transition-all duration-300;
        }
        .comment-box {
            @apply bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200;
        }
        .note-card {
            @apply transition-all duration-200 transform hover:scale-102;
        }
        .progress-bar {
            @apply absolute bottom-0 left-0 h-2 bg-blue-500 transition-all duration-300;
        }
        .show-more {
            color: blue;
            cursor: pointer;
        }
        .dropdown {
            @apply relative inline-block;
        }
        .dropdown-content {
            @apply hidden absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-md overflow-hidden z-50;
        }
        .dropdown:hover .dropdown-content {
            @apply block;
        }
        .dropdown-item {
            @apply block px-4 py-2 text-gray-800 hover:bg-gray-200 transition-colors duration-200;
        }
        .dashboard-info {
            @apply bg-white rounded-lg shadow-md p-4 text-center flex flex-col items-center justify-center transition-all duration-300;
        }
        .dashboard-info i {
            @apply text-4xl mb-2;
        }
        .dashboard-info p {
            @apply text-lg font-semibold;
        }
        .separator {
            @apply my-4 border-t-2 border-gray-300;
        }
        .category {
            cursor: pointer;
        }
        .category-content {
            display: none;
        }
        .blurred-notes {
            filter: blur(5px);
            pointer-events: none;
        }
        .loader {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
        }
        .spinner {
            @apply w-16 h-16 border-4 border-t-4 border-t-transparent border-white rounded-full animate-spin;
        }
    </style>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
      import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA3jZ-j_PfwqiSPDnSGdgeYMK0DFlNWEjg",
        authDomain: "anotacoes-75ec5.firebaseapp.com",
        projectId: "anotacoes-75ec5",
        storageBucket: "anotacoes-75ec5.firebasestorage.app",
        messagingSenderId: "32475295961",
        appId: "1:32475295961:web:914ba38766ffdeedce8ec8",
        measurementId: "G-M03K5XJ0R3"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);

      // Utility function to get current date and time
      const getCurrentDateTime = () => {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      };

      // Function to handle adding a new note
      const addNote = (formData) => {
        const sanitizedData = {
          contractNumber: formData.contractNumber,
          locator: formData.locator,
          tenant: formData.tenant,
          problem: formData.problem,
          address: formData.address
        };

        const newNoteKey = push(ref(database, 'notes')).key;

        const newNoteData = {
          ...sanitizedData,
          status: 'open',
          comments: [],
          createdAt: getCurrentDateTime(),
          createdBy: currentUser.email
        };

        set(ref(database, 'notes/' + newNoteKey), newNoteData)
          .then(() => {
            showNotification('Anotação criada com sucesso!', 'success');
          })
          .catch((error) => {
            showNotification('Erro ao criar anotação: ' + error.message, 'error');
          });
      };

      // Function to handle submitting a comment
      const handleCommentSubmit = (noteKey, commentText) => {
        if (!commentText.trim()) {
          showNotification('Comentário não pode estar vazio', 'error');
          return;
        }

        const newCommentKey = push(ref(database, `notes/${noteKey}/comments`)).key;

        const comment = {
          id: newCommentKey,
          text: commentText,
          dateTime: getCurrentDateTime(),
          author: currentUser.email
        };

        set(ref(database, `notes/${noteKey}/comments/${newCommentKey}`), comment)
          .then(() => {
            showNotification('Comentário adicionado com sucesso!', 'success');
            update(ref(database, `notes/${noteKey}`), { status: 'verified' });
          })
          .catch((error) => {
            showNotification('Erro ao adicionar comentário: ' + error.message, 'error');
          });
      };

      // Function to handle editing a comment
      const editComment = (noteKey, commentId, newText) => {
        const commentRef = ref(database, `notes/${noteKey}/comments/${commentId}`);
        update(commentRef, {
          text: newText,
          editedAt: getCurrentDateTime()
        })
          .then(() => {
            showNotification('Comentário atualizado com sucesso!', 'success');
            update(ref(database, `notes/${noteKey}`), { status: 'verified' });
          })
          .catch((error) => {
            showNotification('Erro ao atualizar comentário: ' + error.message, 'error');
          });
      };

      // Function to handle deleting a comment
      const deleteComment = (noteKey, commentId) => {
        const commentRef = ref(database, `notes/${noteKey}/comments/${commentId}`);
        remove(commentRef)
          .then(() => {
            showNotification('Comentário excluído com sucesso!', 'success');
          })
          .catch((error) => {
            showNotification('Erro ao excluir comentário: ' + error.message, 'error');
          });
      };

      // Function to handle finalizing a note
      const finalizeNote = (noteKey) => {
        const noteRef = ref(database, `notes/${noteKey}`);
        update(noteRef, {
          status: 'closed',
          closedAt: getCurrentDateTime()
        })
          .then(() => {
            showNotification('Nota finalizada com sucesso!', 'success');
          })
          .catch((error) => {
            showNotification('Erro ao finalizar nota: ' + error.message, 'error');
          });
      };

      // Function to handle reopening a note
      const reopenNote = (noteKey) => {
        const noteRef = ref(database, `notes/${noteKey}`);
        update(noteRef, {
          status: 'open',
          closedAt: null
        })
          .then(() => {
            showNotification('Nota reaberta com sucesso!', 'success');
          })
          .catch((error) => {
            showNotification('Erro ao reabrir nota: ' + error.message, 'error');
          });
      };

      // Function to show notifications
      const showNotification = (message, type = 'success') => {
        const notificationArea = document.getElementById('notificationArea');
        notificationArea.innerHTML = ''; // Clear existing notifications

        const notification = document.createElement('div');
        notification.className = `notification ${type === 'success' ? 'notification-success' : type === 'alert' ? 'notification-alert' : 'notification-error'}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);
        setTimeout(() => notificationArea.removeChild(notification), 5000);
      };

      // Function to sanitize input
      const sanitizeInput = (input) => {
        if (typeof input !== 'string') return '';
        return input.trim().replace(/[<>]/g, '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      };

      // Function to validate form data
      const validateForm = (formData) => {
        const errors = [];
        
        if (!formData.contractNumber.match(/^[A-Za-z0-9-]+$/)) {
            errors.push('Número de contrato inválido - use apenas letras, números e hífen');
        }
        
        if (formData.locator.length < 3) {
            errors.push('Nome do Locador deve ter ao menos 3 caracteres');
        }

        if (formData.tenant.length < 3) {
            errors.push('Nome do Locatário deve ter ao menos 3 caracteres');
        }
        
        if (formData.problem.length < 10) {
            errors.push('Problema deve ter ao menos 10 caracteres');
        }
        
        if (formData.address.length < 5) {
            errors.push('Endereço deve ter ao menos 5 caracteres');
        }
        
        return errors;
      };

      // Function to show the login modal
      const showLogin = () => {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('logoSection').classList.add('hidden');
        document.getElementById('mainLayout').classList.add('hidden');
      };

      // Function to handle login
      const login = (email, password) => {
        if (email === 'manutencao@madia.com.br' && password === 'password123') {
          currentUser = { email };
          showMainLayout();
          showNotification('Login bem-sucedido!', 'success');
        } else {
          showNotification('E-mail ou senha incorretos.', 'error');
        }
      };

      // Function to show the main layout
      const showMainLayout = () => {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('logoSection').classList.remove('hidden');
        document.getElementById('mainLayout').classList.remove('hidden');
      };

      // Dummy current user for demonstration purposes
      let currentUser = null;

      // Event listener for the login form
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        login(email, password);
      });

      // Example usage
      document.getElementById('createNoteBtn').addEventListener('click', () => {
        if (currentUser) {
          const formData = {
            contractNumber: '123-456',
            locator: 'John Doe',
            tenant: 'Jane Smith',
            problem: 'Leaking faucet',
            address: '123 Main St'
          };
          addNote(formData);
        } else {
          showLogin();
        }
      });

      // Function to monitor typing status and update Firebase
      const startTyping = () => {
        const typingStatusRef = ref(database, 'typingStatus/' + currentUser.email.replace(/\./g, '_'));
        set(typingStatusRef, true);
      };

      const stopTyping = () => {
        const typingStatusRef = ref(database, 'typingStatus/' + currentUser.email.replace(/\./g, '_'));
        set(typingStatusRef, false);
      };

      // Add event listeners to the input field for typing detection
      document.addEventListener('DOMContentLoaded', () => {
        const inputField = document.getElementById('commentText');
        if (inputField) {
          inputField.addEventListener('keydown', startTyping);
          inputField.addEventListener('blur', stopTyping);
        }

        const typingStatusContainer = document.getElementById('typingStatusContainer');
        onValue(ref(database, 'typingStatus'), (snapshot) => {
          const typingStatus = snapshot.val();
          typingStatusContainer.innerHTML = '';
          for (const user in typingStatus) {
            if (typingStatus[user]) {
              const typingIndicator = document.createElement('div');
              typingIndicator.textContent = `${user.replace(/_/g, '.')} está digitando...`;
              typingStatusContainer.appendChild(typingIndicator);
            }
          }
        });
      });
    </script>
</head>

<body class="flex flex-col min-h-screen bg-gradient-to-r from-gray-200 via-gray-400 to-gray-600 text-black">

<!-- Loader -->
<div id="loader" class="loader hidden">
    <div class="spinner"></div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal-overlay flex items-center justify-center">
    <div class="modal-content p-6 w-full max-w-md">
        <h2 class="text-xl font-semibold mb-4 text-center text-black">Login</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="loginEmail" class="block text-gray-700">E-mail: *</label>
                <input type="email" 
                       id="loginEmail" 
                       required
                       class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
            </div>
            <div>
                <label for="loginPassword" class="block text-gray-700">Senha: *</label>
                <input type="password" 
                       id="loginPassword" 
                       required
                       class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="submit" class="btn btn-wine-red">
                    <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Logo Section -->
<div id="logoSection" class="mb-6 hidden">
    <img src="https://i.ibb.co/R3dKTYr/Madia-Im-veis-40-anos.webp" alt="Logo" class="mx-auto h-24">
</div>

<!-- Main Layout -->
<div id="mainLayout" class="flex flex-1 w-full hidden">

    <!-- Main Content -->
    <div class="flex-1 flex flex-col items-center p-4">

        <!-- User Info -->
        <div id="userInfo" class="mb-4 text-center text-xl font-semibold hidden">Logado: <span id="loggedUser"></span></div>

<!-- Main Controls -->
        <div class="mb-6 w-full max-w-4xl flex justify-center space-x-4">
            <button id="createNoteBtn" class="btn btn-wine-red" aria-label="Criar Anotação">
                <i class="fas fa-plus mr-2"></i>Criar anotação
            </button>
            <button id="createScheduleBtn" class="btn btn-wine-red" aria-label="Criar Agendamento">
                <i class="fas fa-calendar-alt mr-2"></i>Criar Agendamento
            </button>
            <button id="importNotesBtn" class="btn btn-gray" aria-label="Importar Contratos">
                <i class="fas fa-file-import mr-2"></i>Importar Contratos
            </button>
            <button id="downloadNotesBtn" class="btn btn-gray" aria-label="Baixar Todos os Contratos">
                <i class="fas fa-download mr-2"></i>Baixar Todos os Contratos
            </button>
            <button id="showDashboardBtn" class="btn btn-wine-red" aria-label="Dashboard">
                <i class="fas fa-chart-bar mr-2"></i>Dashboard
            </button>
            <button id="logoutBtn" class="btn btn-gray" aria-label="Logout">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
            <input type="file" id="fileInput" class="hidden" accept=".json">
        </div>

        <!-- Notification Area -->
        <div id="notificationArea" class="w-full max-w-4xl mb-4 text-center"></div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="w-full max-w-2xl mb-6 hidden text-center bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-black">Dashboard</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="dashboard-info">
                    <i class="fas fa-folder-open text-red-900"></i>
                    <p id="openCount">Abertos: 0</p>
                </div>
                <div class="dashboard-info">
                    <i class="fas fa-check text-green-500"></i>
                    <p id="closedCount">Fechados: 0</p>
                </div>
                <div class="dashboard-info">
                    <i class="fas fa-calendar-alt text-yellow-500"></i>
                    <p id="scheduledCount">Em Agendamento: 0</p>
                </div>
                <div class="dashboard-info">
                    <i class="fas fa-check-double text-purple-500"></i>
                    <p id="verifiedCount">Verificados Hoje: 0</p>
                </div>
            </div>
            <div class="relative w-full h-96 mx-auto">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div class="separator"></div>

        <!-- Note Creation Modal -->
        <div id="noteModal" class="modal-overlay hidden">
            <div class="modal-content p-6 w-full max-w-md">
                <h2 class="text-xl font-semibold mb-4 text-center text-black">Criar Anotação</h2>
                <form id="noteForm" class="space-y-4">
                    <div>
                        <label for="contractNumber" class="block text-gray-700">Número de Contrato: *</label>
                        <input type="text" 
                               id="contractNumber" 
                               required
                               pattern="[A-Za-z0-9-]+"
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                        <span id="contractNumberError" class="text-red-500 hidden">Número de contrato inválido - use apenas letras, números e hífen</span>
                    </div>

                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="locator" class="block text-gray-700">Locador: *</label>
                            <input type="text" 
                                   id="locator" 
                                   required
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                            <span id="locatorError" class="text-red-500 hidden">Nome do Locador deve ter ao menos 3 caracteres</span>
                        </div>

                        <div class="w-1/2">
                            <label for="tenant" class="block text-gray-700">Locatário: *</label>
                            <input type="text" 
                                   id="tenant" 
                                   required
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                            <span id="tenantError" class="text-red-500 hidden">Nome do Locatário deve ter ao menos 3 caracteres</span>
                        </div>
                    </div>

                    <div>
                        <label for="address" class="block text-gray-700">Endereço: *</label>
                        <input type="text" 
                               id="address" 
                               required
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                        <span id="addressError" class="text-red-500 hidden">Endereço deve ter ao menos 5 caracteres</span>
                    </div>

                    <div>
                        <label for="problem" class="block text-gray-700">Problema: *</label>
                        <textarea id="problem" 
                                 required
                                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 min-h-[100px] text-black"></textarea>
                        <span id="problemError" class="text-red-500 hidden">Problema deve ter ao menos 10 caracteres</span>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancelNoteBtn" class="btn btn-gray">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-wine-red">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="separator"></div>

        <!-- Schedule Creation Modal -->
        <div id="scheduleModal" class="modal-overlay hidden">
            <div class="modal-content p-6 w-full max-w-md">
                <h2 class="text-xl font-semibold mb-4 text-center text-black">Criar Agendamento</h2>
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="searchContract" class="block text-gray-700">Pesquisar Contrato:</label>
                        <input type="text" id="searchContract" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black" placeholder="Buscar contrato...">
                    </div>
                    <div>
                        <label for="existingContract" class="block text-gray-700">Selecionar Contrato: *</label>
                        <select id="existingContract" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                            <option value="">Selecione um contrato...</option>
                        </select>
                    </div>

                    <div>
                        <label for="providerName" class="block text-gray-700">Nome do Prestador: *</label>
                        <input type="text" 
                               id="providerName" 
                               required
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                    </div>

                    <div>
                        <label for="scheduleDate" class="block text-gray-700">Data do Agendamento: *</label>
                        <input type="date" 
                               id="scheduleDate" 
                               required
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                    </div>

                    <div>
                        <label for="scheduleDescription" class="block text-gray-700">Descrição do Agendamento: *</label>
                        <textarea id="scheduleDescription" 
                                  required
                                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 min-h-[100px] text-black"></textarea>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancelScheduleModalBtn" class="btn btn-gray">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-wine-red">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="separator"></div>

        <!-- Note Details Modal -->
        <div id="noteDetailsModal" class="modal-overlay hidden">
            <div class="modal-content p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-semibold mb-4 text-center text-black">Detalhes da Anotação</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Coluna da esquerda - Detalhes -->
                    <div class="space-y-4">
                        <div id="noteDetailsContent" class="bg-white p-4 rounded-lg shadow-md relative"></div>
                        
                        <div class="flex space-x-2">
                            <button type="button" id="copyDetailsBtn" class="btn btn-green flex-1">
                                <i class="fas fa-copy mr-2"></i>Copiar
                            </button>
                            <button type="button" id="downloadContractBtn" class="btn btn-yellow flex-1">
                                <i class="fas fa-file-download mr-2"></i>Baixar
                            </button>
                            <button type="button" id="cancelScheduleBtn" class="btn btn-red flex-1">
                                <i class="fas fa-calendar-times mr-2"></i>Cancelar Agendamento
                            </button>
                            <button type="button" id="deleteNoteBtn" class="btn btn-red flex-1">
                                <i class="fas fa-trash mr-2"></i>Excluir
                            </button>
                            <button type="button" id="finalizeNoteBtn" class="btn btn-green flex-1 hidden">
                                <i class="fas fa-check mr-2"></i>Finalizar
                            </button>
                            <button type="button" id="reopenNoteBtn" class="btn btn-wine-red flex-1 hidden">
                                <i class="fas fa-undo mr-2"></i>Reabrir
                            </button>
                        </div>
                    </div>

                    <!-- Coluna da direita - Comentários -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-black">Comentários</h3>
                            
                            <form id="commentForm" class="mb-4">
                                <textarea id="commentText" 
                                         required
                                         class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 min-h-[80px] text-black"
                                         placeholder="Digite seu comentário aqui... (Pressione Enter para enviar)"></textarea>
                                <button type="submit" class="btn btn-wine-red w-full mt-2">
                                    <i class="fas fa-comment mr-2"></i>Adicionar Comentário
                                </button>
                            </form>

                            <div id="commentsContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                            <button id="showMoreCommentsBtn" class="show-more">Mostrar Mais Comentários</button>
                            <button id="backToTopBtn" class="show-more hidden">Voltar ao Início dos Comentários</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 text-right">
                    <button type="button" id="closeDetailsBtn" class="btn btn-gray">
                        <i class="fas fa-times mr-2"></i>Fechar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Notes Section -->
    <div class="w-1/4 p-4">
        <!-- Filter Controls -->
        <div class="mb-4 flex flex-col space-y-2">
            <select id="statusFilter" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                <option value="all">Todos os Chamados</option>
                <option value="open">Abertos</option>
                <option value="scheduled">Em Agendamento</option>
                <option value="verified">Verificados Hoje</option>
                <option value="closed">Fechados</option>
            </select>
            <select id="dateFilter" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black">
                <option value="newest">Mais Recentes</option>
                <option value="oldest">Mais Antigos</option>
            </select>
        </div>

        <!-- Search and Filter Controls -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="searchInput" 
                       placeholder="Pesquisar contratos..." 
                       class="w-full px-4 py-2 pl-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-400 text-black"
                       aria-label="Pesquisar contratos">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <div id="notesContainer" class="w-full grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="mt-4 flex justify-center items-center space-x-4">
            <button id="prevPageBtn" class="btn btn-wine-red"><i class="fas fa-chevron-left"></i></button>
            <button id="nextPageBtn" class="btn btn-wine-red"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyA3jZ-j_PfwqiSPDnSGdgeYMK0DFlNWEjg",
    authDomain: "anotacoes-75ec5.firebaseapp.com",
    projectId: "anotacoes-75ec5",
    storageBucket: "anotacoes-75ec5.firebasestorage.app",
    messagingSenderId: "32475295961",
    appId: "1:32475295961:web:914ba38766ffdeedce8ec8",
    measurementId: "G-M03K5XJ0R3"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

// Function to handle editing a comment
const editComment = (noteKey, commentId, newText) => {
    const commentRef = ref(database, `notes/${noteKey}/comments/${commentId}`);
    update(commentRef, {
        text: sanitizeInput(newText),
        editedAt: getCurrentDateTime()
    })
    .then(() => {
        showNotification('Comentário atualizado com sucesso!', 'success');
        update(ref(database, `notes/${noteKey}`), { status: 'verified' });
    })
    .catch((error) => {
        showNotification('Erro ao atualizar comentário: ' + error.message, 'error');
    });
};

// Function to handle deleting a comment
const deleteComment = (noteKey, commentId) => {
    const commentRef = ref(database, `notes/${noteKey}/comments/${commentId}`);
    remove(commentRef)
    .then(() => {
        showNotification('Comentário excluído com sucesso!', 'success');
    })
    .catch((error) => {
        showNotification('Erro ao excluir comentário: ' + error.message, 'error');
    });
};

// Function to handle finalizing a note
const finalizeNote = (noteKey) => {
    const noteRef = ref(database, `notes/${noteKey}`);
    update(noteRef, {
        status: 'closed',
        closedAt: getCurrentDateTime()
    })
    .then(() => {
        showNotification('Nota finalizada com sucesso!', 'success');
    })
    .catch((error) => {
        showNotification('Erro ao finalizar nota: ' + error.message, 'error');
    });
};

// Function to handle reopening a note
const reopenNote = (noteKey) => {
    const noteRef = ref(database, `notes/${noteKey}`);
    update(noteRef, {
        status: 'open',
        closedAt: null
    })
    .then(() => {
        showNotification('Nota reaberta com sucesso!', 'success');
    })
    .catch((error) => {
        showNotification('Erro ao reabrir nota: ' + error.message, 'error');
    });
};

// Function to show notifications
const showNotification = (message, type = 'success') => {
    const notificationArea = document.getElementById('notificationArea');
    notificationArea.innerHTML = ''; // Clear existing notifications

    const notification = document.createElement('div');
    notification.className = `notification ${type === 'success' ? 'notification-success' : type === 'alert' ? 'notification-alert' : 'notification-error'}`;
    notification.textContent = message;
    notificationArea.appendChild(notification);
    setTimeout(() => notificationArea.removeChild(notification), 5000);
};

// Function to sanitize input
const sanitizeInput = (input) => {
    if (typeof input !== 'string') return '';
    return input.trim().replace(/[<>]/g, '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
};

// Function to validate form data
const validateForm = (formData) => {
    const errors = [];
    
    if (!formData.contractNumber.match(/^[A-Za-z0-9-]+$/)) {
        errors.push('Número de contrato inválido - use apenas letras, números e hífen');
    }
    
    if (formData.locator.length < 3) {
        errors.push('Nome do Locador deve ter ao menos 3 caracteres');
    }

    if (formData.tenant.length < 3) {
        errors.push('Nome do Locatário deve ter ao menos 3 caracteres');
    }
    
    if (formData.problem.length < 10) {
        errors.push('Problema deve ter ao menos 10 caracteres');
    }
    
    if (formData.address.length < 5) {
        errors.push('Endereço deve ter ao menos 5 caracteres');
    }
    
    return errors;
};

// Function to show the login modal
const showLogin = () => {
    document.getElementById('loginModal').classList.remove('hidden');
    document.getElementById('logoSection').classList.add('hidden');
    document.getElementById('mainLayout').classList.add('hidden');
};

// Function to handle login
const login = (email, password) => {
    if (email === 'manutencao@madia.com.br' && password === 'password123') {
        currentUser = { email };
        showMainLayout();
        showNotification('Login bem-sucedido!', 'success');
    } else {
        showNotification('E-mail ou senha incorretos.', 'error');
    }
};

// Function to show the main layout
const showMainLayout = () => {
    document.getElementById('loginModal').classList.add('hidden');
    document.getElementById('logoSection').classList.remove('hidden');
    document.getElementById('mainLayout').classList.remove('hidden');
};

// Dummy current user for demonstration purposes
let currentUser = null;

// Event listener for the login form
document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    login(email, password);
});

// Example usage
document.getElementById('createNoteBtn').addEventListener('click', () => {
    if (currentUser) {
        const formData = {
            contractNumber: '123-456',
            locator: 'John Doe',
            tenant: 'Jane Smith',
            problem: 'Leaking faucet',
            address: '123 Main St'
        };
        addNote(formData);
    } else {
        showLogin();
    }
});

// Function to monitor typing status and update Firebase
const startTyping = () => {
    const typingStatusRef = ref(database, 'typingStatus/' + currentUser.email.replace(/\./g, '_'));
    set(typingStatusRef, true);
};

const stopTyping = () => {
    const typingStatusRef = ref(database, 'typingStatus/' + currentUser.email.replace(/\./g, '_'));
    set(typingStatusRef, false);
};

// Add event listeners to the input field for typing detection
document.addEventListener('DOMContentLoaded', () => {
    const inputField = document.getElementById('commentText');
    if (inputField) {
        inputField.addEventListener('keydown', startTyping);
        inputField.addEventListener('blur', stopTyping);
    }

    const typingStatusContainer = document.getElementById('typingStatusContainer');
    onValue(ref(database, 'typingStatus'), (snapshot) => {
        const typingStatus = snapshot.val();
        typingStatusContainer.innerHTML = '';
        for (const user in typingStatus) {
            if (typingStatus[user]) {
                const typingIndicator = document.createElement('div');
                typingIndicator.textContent = `${user.replace(/_/g, '.')} está digitando...`;
                typingStatusContainer.appendChild(typingIndicator);
            }
        }
    });
});
</script>
</body>
</html>
