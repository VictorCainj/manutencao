<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Anotações de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .btn {
            @apply px-4 py-2 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-colors duration-200;
        }
        .btn-blue {
            @apply bg-blue-500 hover:bg-blue-700 focus:ring-blue-400;
        }
        .btn-green {
            @apply bg-green-500 hover:bg-green-700 focus:ring-green-400;
        }
        .btn-yellow {
            @apply bg-yellow-500 hover:bg-yellow-700 focus:ring-yellow-400;
        }
        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-700 focus:ring-gray-400;
        }
        .btn-red {
            @apply bg-red-500 hover:bg-red-700 focus:ring-red-400;
        }
        .btn-orange {
            @apply bg-orange-500 hover:bg-orange-700 focus:ring-orange-400;
        }
        .notification {
            @apply fixed top-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 ease-in-out z-50 font-semibold;
            animation: slideIn 0.3s ease-out;
        }
        .notification-success {
            @apply bg-green-500 text-white border-l-4 border-green-700;
        }
        .notification-error {
            @apply bg-red-500 text-white border-l-4 border-red-700;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 z-40;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-lg transform transition-all duration-300;
        }
        .comment-box {
            @apply bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 mb-4;
        }
        .note-card {
            @apply bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 mb-4 cursor-pointer;
        }
        .progress-bar {
            @apply absolute bottom-0 left-0 h-2 bg-blue-500 transition-all duration-300;
        }
        .date-input {
            @apply px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>

    <body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
    <!-- Notification Component -->
    <div id="notification" class="notification hidden"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center hidden z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        <div class="w-64 h-2 mt-4 bg-gray-200 rounded-full overflow-hidden">
            <div class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="mb-6 space-x-4">
        <button id="createNoteBtn" class="btn btn-blue">
            <i class="fas fa-plus mr-2"></i>Criar anotação
        </button>
        <button id="importNotesBtn" class="btn btn-green">
            <i class="fas fa-file-import mr-2"></i>Importar Contratos
        </button>
        <button id="downloadNotesBtn" class="btn btn-yellow">
            <i class="fas fa-download mr-2"></i>Baixar Todos os Contratos
        </button>
        <input type="file" id="fileInput" class="hidden" accept=".json">
    </div>

    <!-- Search and Filter Controls -->
    <div class="mb-6 w-full max-w-4xl space-y-4">
        <div class="relative">
            <input type="text" 
                   id="searchInput" 
                   placeholder="Pesquisar contratos..." 
                   class="w-full px-4 py-2 pl-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                   aria-label="Pesquisar contratos">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>

        <div class="flex space-x-4 items-center">
            <select id="dateSort" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="newest">Mais recentes primeiro</option>
                <option value="oldest">Mais antigos primeiro</option>
            </select>
            <select id="statusFilter" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="all">Todos os status</option>
                <option value="open">Abertos</option>
                <option value="scheduled">Em agendamento</option>
                <option value="closed">Fechados</option>
            </select>
        </div>
    </div>

    <!-- Note Creation Modal -->
    <div id="noteModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-center">Criar Anotação</h2>
            <form id="noteForm" class="space-y-4">
                <div>
                    <label for="contractNumber" class="block text-gray-700">Número de Contrato: *</label>
                    <input type="text" 
                           id="contractNumber" 
                           required
                           pattern="[A-Za-z0-9-]+"
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           placeholder="Digite o número do contrato">
                </div>

                <div>
                    <label for="locator" class="block text-gray-700">Locador: *</label>
                    <input type="text" 
                           id="locator" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           placeholder="Nome do locador">
                </div>

                <div>
                    <label for="tenant" class="block text-gray-700">Locatário: *</label>
                    <input type="text" 
                           id="tenant" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           placeholder="Nome do locatário">
                </div>

                <div>
                    <label for="problem" class="block text-gray-700">Problema: *</label>
                    <textarea id="problem" 
                             required
                             class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[100px]"
                             placeholder="Descreva o problema"></textarea>
                </div>

                <div>
                    <label for="creationDate" class="block text-gray-700">Data de Criação: *</label>
                    <input type="date" 
                           id="creationDate" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label for="address" class="block text-gray-700">Endereço: *</label>
                    <input type="text" 
                           id="address" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           placeholder="Endereço completo">
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelBtn" class="btn btn-gray">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-blue">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

        <!-- Note Details Modal -->
    <div id="noteDetailsModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Detalhes da Anotação</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna da esquerda - Detalhes -->
                <div class="space-y-4">
                    <div id="noteDetailsContent" class="bg-white p-4 rounded-lg shadow-md"></div>
                    
                    <!-- Container para Agendamento -->
                    <div id="schedulingContainer" class="hidden space-y-4">
                        <div>
                            <label for="scheduleDate" class="block text-gray-700 mb-2">Data de Agendamento:</label>
                            <input type="date" 
                                   id="scheduleDate" 
                                   class="date-input w-full">
                        </div>
                        <div>
                            <label for="serviceProvider" class="block text-gray-700 mb-2">Prestador de Serviço:</label>
                            <input type="text" 
                                   id="serviceProvider" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   placeholder="Nome do prestador de serviço">
                        </div>
                    </div>

                    <!-- Status Buttons -->
                    <div id="statusButtons" class="flex space-x-2">
                        <button class="btn btn-blue flex-1 status-btn" data-status="open">
                            <i class="fas fa-folder-open mr-2"></i>Aberto
                        </button>
                        <button class="btn btn-orange flex-1 status-btn" data-status="scheduled">
                            <i class="fas fa-calendar-alt mr-2"></i>Agendar
                        </button>
                        <button class="btn btn-green flex-1 status-btn" data-status="closed">
                            <i class="fas fa-check-circle mr-2"></i>Finalizar
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <button type="button" id="copyDetailsBtn" class="btn btn-green flex-1">
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                        <button type="button" id="downloadContractBtn" class="btn btn-yellow flex-1">
                            <i class="fas fa-file-download mr-2"></i>Baixar
                        </button>
                        <button type="button" id="deleteNoteBtn" class="btn btn-red flex-1">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>

                <!-- Coluna da direita - Comentários -->
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Comentários</h3>
                        
                        <form id="commentForm" class="mb-4">
                            <textarea id="commentText" 
                                     required
                                     class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[80px]"
                                     placeholder="Digite seu comentário aqui..."
                                     data-prevent-blur="true"></textarea>
                            <button type="submit" class="btn btn-blue w-full mt-2">
                                <i class="fas fa-comment mr-2"></i>Adicionar Comentário
                            </button>
                        </form>

                        <div id="commentsContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-right">
                <button type="button" id="closeDetailsBtn" class="btn btn-gray">
                    <i class="fas fa-times mr-2"></i>Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Notes Container -->
    <div id="notesContainer" class="w-full max-w-4xl grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    </div>

<script>
// Utility Functions
const utils = {
    formatDate: (date, includeTime = false) => {
        if (!date) return '';
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const pad = (num) => String(num).padStart(2, '0');
        const dateStr = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        
        if (!includeTime) return dateStr;
        return `${dateStr} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },

    parseDateInput: (dateStr) => {
        if (!dateStr) return null;
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    },

    showNotification: (message, type = 'success') => {
        const notification = document.getElementById('notification');
        notification.className = `notification ${type === 'success' ? 'notification-success' : 'notification-error'}`;
        notification.textContent = message;
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.add('hidden'), 3000);
    },

    showLoading: (show = true, progress = 0) => {
        const spinner = document.getElementById('loadingSpinner');
        const progressBar = spinner.querySelector('.progress-bar');
        spinner.classList.toggle('hidden', !show);
        if (show && progressBar) {
            progressBar.style.width = `${progress}%`;
        }
    },

    sanitizeInput: (input) => {
        if (typeof input !== 'string') return '';
        return input.trim()
                   .replace(/[<>]/g, '')
                   .replace(/&/g, '&amp;')
                   .replace(/"/g, '&quot;')
                   .replace(/'/g, '&#39;');
    }
};

    class NoteManager {
    constructor() {
        if (window.noteManager) {
            return window.noteManager;
        }

        this.notes = {};
        this.currentUser = 'VictorCainj';
        this.currentDateTime = '2025-01-24 00:52:17';
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.initialize());
        } else {
            this.initialize();
        }

        window.noteManager = this;
    }

    initialize() {
        this.loadFromLocalStorage();
        this.cleanInvalidNotes();
        this.initializeEventListeners();
        this.activeNoteKey = null;
        this.renderAllNotes();
    }

    renderAllNotes() {
        const container = document.getElementById('notesContainer');
        container.innerHTML = '';
        
        Object.keys(this.notes).forEach(key => {
            this.renderNote(key);
        });
    }

    renderNote(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        const container = document.getElementById('notesContainer');
        const existingNote = document.querySelector(`[data-note-key="${noteKey}"]`);
        
        if (existingNote) {
            existingNote.remove();
        }

        const noteElement = document.createElement('div');
        noteElement.className = 'note-card';
        noteElement.setAttribute('data-note-key', noteKey);
        noteElement.setAttribute('data-contract', note.contractNumber);
        noteElement.setAttribute('data-locator', note.locator);
        noteElement.setAttribute('data-tenant', note.tenant);
        noteElement.setAttribute('data-address', note.address);
        noteElement.setAttribute('data-status', note.status);
        noteElement.setAttribute('data-date', note.createdAt);

        const statusColors = {
            'open': 'text-blue-600',
            'scheduled': 'text-orange-600',
            'closed': 'text-green-600'
        };

        const statusIcons = {
            'open': 'fa-folder-open',
            'scheduled': 'fa-calendar-alt',
            'closed': 'fa-check-circle'
        };

        noteElement.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-semibold">${utils.sanitizeInput(note.contractNumber)}</h3>
                <i class="fas ${statusIcons[note.status]} ${statusColors[note.status]}"></i>
            </div>
            <p class="text-sm text-gray-600 mb-2">${utils.sanitizeInput(note.locator)}</p>
            <p class="text-sm text-gray-600 mb-2">${utils.sanitizeInput(note.tenant)}</p>
            <p class="text-sm text-gray-500 truncate">${utils.sanitizeInput(note.address)}</p>
            <div class="mt-2 text-xs text-gray-400">
                ${utils.formatDate(note.createdAt)}
            </div>
        `;

        noteElement.addEventListener('click', () => this.showNoteDetails(noteKey));
        
        if (existingNote) {
            container.replaceChild(noteElement, existingNote);
        } else {
            container.appendChild(noteElement);
        }
    }

    initializeEventListeners() {
        const elementHandlers = {
            'createNoteBtn': {
                event: 'click',
                handler: () => {
                    const noteModal = document.getElementById('noteModal');
                    const contractNumber = document.getElementById('contractNumber');
                    const creationDate = document.getElementById('creationDate');
                    
                    noteModal.classList.remove('hidden');
                    contractNumber.focus();
                    creationDate.valueAsDate = new Date();
                }
            },
            'cancelBtn': {
                event: 'click',
                handler: () => {
                    document.getElementById('noteModal').classList.add('hidden');
                    document.getElementById('noteForm').reset();
                }
            },
            'noteForm': {
                event: 'submit',
                handler: (e) => {
                    e.preventDefault();
                    this.handleFormSubmit();
                }
            },
            'searchInput': {
                event: 'input',
                handler: (e) => {
                    this.handleSearch(e.target.value);
                }
            },
            'dateSort': {
                event: 'change',
                handler: () => {
                    this.filterAndSortNotes();
                }
            },
            'statusFilter': {
                event: 'change',
                handler: () => {
                    this.filterAndSortNotes();
                }
            },
            'importNotesBtn': {
                event: 'click',
                handler: () => {
                    document.getElementById('fileInput').click();
                }
            },
            'fileInput': {
                event: 'change',
                handler: (e) => {
                    this.handleFileImport(e);
                }
            },
            'downloadNotesBtn': {
                event: 'click',
                handler: () => {
                    this.exportAllNotes();
                }
            },
            'closeDetailsBtn': {
                event: 'click',
                handler: () => {
                    document.getElementById('noteDetailsModal').classList.add('hidden');
                    this.activeNoteKey = null;
                }
            },
            'copyDetailsBtn': {
                event: 'click',
                handler: () => {
                    if (this.activeNoteKey) {
                        this.copyNoteDetails(this.activeNoteKey);
                    }
                }
            },
            'downloadContractBtn': {
                event: 'click',
                handler: () => {
                    if (this.activeNoteKey) {
                        this.exportNote(this.activeNoteKey);
                    }
                }
            },
            'deleteNoteBtn': {
                event: 'click',
                handler: () => {
                    if (this.activeNoteKey) {
                        this.deleteNote(this.activeNoteKey);
                    }
                }
            },
            'commentForm': {
                event: 'submit',
                handler: (e) => {
                    e.preventDefault();
                    this.handleCommentSubmit();
                }
            }
        };

        // Configuração dos event listeners
        for (const [elementId, config] of Object.entries(elementHandlers)) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(config.event, config.handler);
            }
        }

        // Event listeners para botões de status
        document.querySelectorAll('.status-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (this.activeNoteKey) {
                    this.updateNoteStatus(this.activeNoteKey, button.dataset.status);
                }
            });
        });

        // Event listener global para ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('noteModal').classList.add('hidden');
                document.getElementById('noteDetailsModal').classList.add('hidden');
                this.activeNoteKey = null;
            }
        });
    }

    handleSearch(searchTerm) {
        const notes = document.querySelectorAll('.note-card');
        let visibleCount = 0;
        
        notes.forEach(note => {
            const searchData = [
                note.dataset.contract,
                note.dataset.locator,
                note.dataset.tenant,
                note.dataset.address
            ].map(item => item.toLowerCase());

            const isVisible = searchData.some(data => 
                data.includes(searchTerm.toLowerCase())
            );

            note.classList.toggle('hidden', !isVisible);
            if (isVisible) visibleCount++;
        });

        this.updateNoResultsMessage(visibleCount);
    }

    updateNoResultsMessage(visibleCount) {
        const container = document.getElementById('notesContainer');
        const existingMessage = container.querySelector('.no-results-message');
        
        if (existingMessage) {
            existingMessage.remove();
        }

        if (visibleCount === 0) {
            const message = document.createElement('div');
            message.className = 'no-results-message col-span-full text-center text-gray-500 py-8';
            message.textContent = 'Nenhuma anotação encontrada para os filtros selecionados.';
            container.appendChild(message);
        }
    }

    showNoteDetails(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        this.activeNoteKey = noteKey;
        const modal = document.getElementById('noteDetailsModal');
        const detailsContent = document.getElementById('noteDetailsContent');
        const schedulingContainer = document.getElementById('schedulingContainer');
        
        const statusText = {
            'open': 'Aberto',
            'scheduled': note.scheduleDate ? 
                `Agendado para ${utils.formatDate(note.scheduleDate)}${note.serviceProvider ? `\nPrestador: ${note.serviceProvider}` : ''}` : 
                'Em agendamento',
            'closed': 'Finalizado'
        };

        detailsContent.innerHTML = `
            <div class="space-y-4">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold">${utils.sanitizeInput(note.contractNumber)}</h3>
                    <span class="font-semibold ${note.status === 'closed' ? 'text-green-600' : 
                                               note.status === 'scheduled' ? 'text-orange-600' : 
                                               'text-blue-600'}">
                        ${statusText[note.status]}
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="font-semibold">Locador:</p>
                        <p>${utils.sanitizeInput(note.locator)}</p>
                    </div>
                    <div>
                        <p class="font-semibold">Locatário:</p>
                        <p>${utils.sanitizeInput(note.tenant)}</p>
                    </div>
                    <div class="col-span-full">
                        <p class="font-semibold">Endereço:</p>
                        <p>${utils.sanitizeInput(note.address)}</p>
                    </div>
                    <div class="col-span-full">
                        <p class="font-semibold">Problema:</p>
                        <p class="whitespace-pre-wrap">${utils.sanitizeInput(note.problem)}</p>
                    </div>
                    <div>
                        <p class="font-semibold">Data de Criação:</p>
                        <p>${utils.formatDate(note.createdAt)}</p>
                    </div>
                    ${note.closedAt ? `
                        <div>
                            <p class="font-semibold">Data de Fechamento:</p>
                            <p>${utils.formatDate(note.closedAt)}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;

        // Configuração dos campos de agendamento
        if (note.status === 'scheduled') {
            schedulingContainer.classList.remove('hidden');
            document.getElementById('scheduleDate').value = note.scheduleDate || '';
            document.getElementById('serviceProvider').value = note.serviceProvider || '';
        } else {
            schedulingContainer.classList.add('hidden');
        }

        // Atualiza estado dos botões de status
        document.querySelectorAll('.status-btn').forEach(button => {
            const isCurrentStatus = button.dataset.status === note.status;
            button.disabled = isCurrentStatus;
            button.classList.toggle('opacity-50', isCurrentStatus);
        });

        modal.classList.remove('hidden');
        this.renderComments(noteKey);
    }

    handleFormSubmit() {
        const formData = {
            contractNumber: document.getElementById('contractNumber').value.trim(),
            locator: document.getElementById('locator').value.trim(),
            tenant: document.getElementById('tenant').value.trim(),
            problem: document.getElementById('problem').value.trim(),
            address: document.getElementById('address').value.trim(),
            createdAt: utils.parseDateInput(document.getElementById('creationDate').value)
        };

        // Validação básica
        if (!formData.contractNumber || !formData.locator || !formData.tenant || 
            !formData.problem || !formData.address || !formData.createdAt) {
            utils.showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
            return;
        }

        try {
            const noteKey = `#${formData.contractNumber}`;
            
            if (this.notes[noteKey]) {
                utils.showNotification('Já existe uma anotação com este número de contrato.', 'error');
                return;
            }

            this.notes[noteKey] = {
                ...formData,
                status: 'open',
                comments: [],
                createdAt: formData.createdAt.toISOString(),
                closedAt: null
            };

            this.saveToLocalStorage();
            this.renderNote(noteKey);
            
            document.getElementById('noteModal').classList.add('hidden');
            document.getElementById('noteForm').reset();
            
            utils.showNotification('Anotação criada com sucesso!', 'success');
            
            // Atualiza a visualização se houver filtros ativos
            this.filterAndSortNotes();
        } catch (error) {
            utils.showNotification('Erro ao criar anotação. Tente novamente.', 'error');
        }
    }

    updateNoteStatus(noteKey, newStatus) {
        const note = this.notes[noteKey];
        if (!note) return;

        const oldStatus = note.status;
        note.status = newStatus;

        switch (newStatus) {
            case 'open':
                note.scheduleDate = null;
                note.serviceProvider = null;
                note.closedAt = null;
                break;

            case 'scheduled':
                note.closedAt = null;
                // Mantém as informações de agendamento se já existirem
                break;

            case 'closed':
                note.closedAt = new Date().toISOString();
                break;
        }

        this.saveToLocalStorage();
        this.renderNote(noteKey);
        this.showNoteDetails(noteKey);

        const statusMessages = {
            'open': 'Anotação reaberta com sucesso!',
            'scheduled': 'Anotação movida para agendamento!',
            'closed': 'Anotação finalizada com sucesso!'
        };

        utils.showNotification(statusMessages[newStatus], 'success');

        if (newStatus === 'scheduled' && oldStatus !== 'scheduled') {
            document.getElementById('scheduleDate').focus();
        }
    }

    deleteNote(noteKey) {
        if (!confirm('Tem certeza que deseja excluir esta anotação? Esta ação não pode ser desfeita.')) {
            return;
        }

        try {
            delete this.notes[noteKey];
            this.saveToLocalStorage();
            
            document.querySelector(`[data-note-key="${noteKey}"]`)?.remove();
            document.getElementById('noteDetailsModal').classList.add('hidden');
            this.activeNoteKey = null;
            
            utils.showNotification('Anotação excluída com sucesso!', 'success');
            
            // Atualiza a mensagem de "nenhum resultado" se necessário
            this.updateNoResultsMessage(Object.keys(this.notes).length);
        } catch (error) {
            utils.showNotification('Erro ao excluir anotação. Tente novamente.', 'error');
        }
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem('notes', JSON.stringify(this.notes));
        } catch (error) {
            utils.showNotification('Erro ao salvar dados. Verifique o espaço disponível.', 'error');
        }
    }

    loadFromLocalStorage() {
        try {
            const savedNotes = localStorage.getItem('notes');
            this.notes = savedNotes ? JSON.parse(savedNotes) : {};
        } catch (error) {
            this.notes = {};
            utils.showNotification('Erro ao carregar dados salvos.', 'error');
        }
    }

    handleCommentSubmit() {
        if (!this.activeNoteKey) return;

        const commentText = document.getElementById('commentText').value.trim();
        if (!commentText) {
            utils.showNotification('O comentário não pode estar vazio.', 'error');
            return;
        }

        try {
            const note = this.notes[this.activeNoteKey];
            if (!note.comments) note.comments = [];

            const newComment = {
                text: commentText,
                dateTime: new Date().toISOString(),
                editedAt: null,
                id: Date.now().toString()
            };

            note.comments.push(newComment);
            this.saveToLocalStorage();
            this.renderComments(this.activeNoteKey);
            
            document.getElementById('commentForm').reset();
            utils.showNotification('Comentário adicionado com sucesso!', 'success');
        } catch (error) {
            utils.showNotification('Erro ao adicionar comentário.', 'error');
        }
    }

    renderComments(noteKey) {
        const commentsContainer = document.getElementById('commentsContainer');
        const note = this.notes[noteKey];
        
        if (!note || !commentsContainer) return;

        commentsContainer.innerHTML = '';

        if (!note.comments || note.comments.length === 0) {
            commentsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    Nenhum comentário ainda. Seja o primeiro a comentar!
                </div>
            `;
            return;
        }

        note.comments.slice().reverse().forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-box';
            commentElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="text-xs text-gray-500">
                        ${utils.formatDate(comment.dateTime, true)}
                        ${comment.editedAt ? ' (editado)' : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 edit-comment-btn" 
                                data-comment-id="${comment.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700 delete-comment-btn" 
                                data-comment-id="${comment.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="comment-text whitespace-pre-wrap">${utils.sanitizeInput(comment.text)}</div>
                <div class="edit-comment-form hidden mt-2">
                    <textarea class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[80px]">${comment.text}</textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button class="btn btn-gray cancel-edit-btn">Cancelar</button>
                        <button class="btn btn-blue save-edit-btn">Salvar</button>
                    </div>
                </div>
            `;

            // Event listeners para edição e exclusão
            const editBtn = commentElement.querySelector('.edit-comment-btn');
            const deleteBtn = commentElement.querySelector('.delete-comment-btn');
            const editForm = commentElement.querySelector('.edit-comment-form');
            const cancelEditBtn = commentElement.querySelector('.cancel-edit-btn');
            const saveEditBtn = commentElement.querySelector('.save-edit-btn');

            editBtn.addEventListener('click', () => {
                editForm.classList.remove('hidden');
                commentElement.querySelector('.comment-text').classList.add('hidden');
            });

            cancelEditBtn.addEventListener('click', () => {
                editForm.classList.add('hidden');
                commentElement.querySelector('.comment-text').classList.remove('hidden');
            });

            saveEditBtn.addEventListener('click', () => {
                const newText = editForm.querySelector('textarea').value.trim();
                if (newText && newText !== comment.text) {
                    this.editComment(noteKey, comment.id, newText);
                }
            });

            deleteBtn.addEventListener('click', () => {
                this.deleteComment(noteKey, comment.id);
            });

            commentsContainer.appendChild(commentElement);
        });
    }

    editComment(noteKey, commentId, newText) {
        try {
            const note = this.notes[noteKey];
            const comment = note.comments.find(c => c.id === commentId);
            
            if (comment) {
                comment.text = newText;
                comment.editedAt = new Date().toISOString();
                this.saveToLocalStorage();
                this.renderComments(noteKey);
                utils.showNotification('Comentário atualizado com sucesso!', 'success');
            }
        } catch (error) {
            utils.showNotification('Erro ao editar comentário.', 'error');
        }
    }

    deleteComment(noteKey, commentId) {
        if (!confirm('Tem certeza que deseja excluir este comentário?')) {
            return;
        }

        try {
            const note = this.notes[noteKey];
            const commentIndex = note.comments.findIndex(c => c.id === commentId);
            
            if (commentIndex !== -1) {
                note.comments.splice(commentIndex, 1);
                this.saveToLocalStorage();
                this.renderComments(noteKey);
                utils.showNotification('Comentário excluído com sucesso!', 'success');
            }
        } catch (error) {
            utils.showNotification('Erro ao excluir comentário.', 'error');
        }
    }

    filterAndSortNotes() {
        const statusFilter = document.getElementById('statusFilter').value;
        const dateSort = document.getElementById('dateSort').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        const notes = document.querySelectorAll('.note-card');
        let visibleCount = 0;

        // Converter NodeList para Array para permitir ordenação
        const notesArray = Array.from(notes);

        // Ordenar notas
        notesArray.sort((a, b) => {
            const dateA = new Date(a.getAttribute('data-date'));
            const dateB = new Date(b.getAttribute('data-date'));
            return dateSort === 'newest' ? dateB - dateA : dateA - dateB;
        });

        // Aplicar filtros e reordenar no DOM
        notesArray.forEach(note => {
            const matchesStatus = statusFilter === 'all' || note.getAttribute('data-status') === statusFilter;
            const matchesSearch = searchTerm === '' || [
                note.getAttribute('data-contract'),
                note.getAttribute('data-locator'),
                note.getAttribute('data-tenant'),
                note.getAttribute('data-address')
            ].some(attr => attr.toLowerCase().includes(searchTerm));

            const isVisible = matchesStatus && matchesSearch;
            note.classList.toggle('hidden', !isVisible);
            
            if (isVisible) {
                visibleCount++;
                document.getElementById('notesContainer').appendChild(note);
            }
        });

        this.updateNoResultsMessage(visibleCount);
    }

    updateSchedulingInfo(noteKey) {
        const note = this.notes[noteKey];
        if (!note || note.status !== 'scheduled') return;

        const scheduleDate = document.getElementById('scheduleDate').value;
        const serviceProvider = document.getElementById('serviceProvider').value.trim();

        note.scheduleDate = scheduleDate;
        note.serviceProvider = serviceProvider;

        this.saveToLocalStorage();
        this.renderNote(noteKey);
        this.showNoteDetails(noteKey);

        utils.showNotification('Informações de agendamento atualizadas!', 'success');
    }

    exportAllNotes() {
        try {
            const dataStr = JSON.stringify(this.notes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `contratos_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            utils.showNotification('Dados exportados com sucesso!', 'success');
        } catch (error) {
            utils.showNotification('Erro ao exportar dados.', 'error');
        }
    }

    exportNote(noteKey) {
        try {
            const note = this.notes[noteKey];
            if (!note) return;

            const dataStr = JSON.stringify({ [noteKey]: note }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `contrato_${note.contractNumber}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            utils.showNotification('Contrato exportado com sucesso!', 'success');
        } catch (error) {
            utils.showNotification('Erro ao exportar contrato.', 'error');
        }
    }

    handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                let importCount = 0;
                let skipCount = 0;

                for (const [key, note] of Object.entries(importedData)) {
                    if (this.notes[key]) {
                        skipCount++;
                        continue;
                    }

                    if (this.validateImportedNote(note)) {
                        this.notes[key] = note;
                        this.renderNote(key);
                        importCount++;
                    } else {
                        skipCount++;
                    }
                }

                this.saveToLocalStorage();
                utils.showNotification(
                    `Importação concluída! ${importCount} notas importadas, ${skipCount} ignoradas.`,
                    'success'
                );
            } catch (error) {
                utils.showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
            }
        };

        reader.onerror = () => {
            utils.showNotification('Erro ao ler arquivo.', 'error');
        };

        reader.readAsText(file);
        event.target.value = '';
    }

    validateImportedNote(note) {
        const requiredFields = [
            'contractNumber',
            'locator',
            'tenant',
            'problem',
            'address',
            'createdAt',
            'status'
        ];

        const isValid = requiredFields.every(field => {
            return note.hasOwnProperty(field) && note[field] !== null && note[field] !== undefined;
        });

        return isValid && ['open', 'scheduled', 'closed'].includes(note.status);
    }

    copyNoteDetails(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        const statusText = {
            'open': 'Aberto',
            'scheduled': 'Agendado',
            'closed': 'Finalizado'
        };

        const details = `
Contrato: ${note.contractNumber}
Status: ${statusText[note.status]}
Locador: ${note.locator}
Locatário: ${note.tenant}
Endereço: ${note.address}
Problema: ${note.problem}
Data de Criação: ${utils.formatDate(note.createdAt)}
${note.closedAt ? `Data de Fechamento: ${utils.formatDate(note.closedAt)}` : ''}
${note.scheduleDate ? `Data de Agendamento: ${utils.formatDate(note.scheduleDate)}` : ''}
${note.serviceProvider ? `Prestador de Serviço: ${note.serviceProvider}` : ''}`.trim();

        navigator.clipboard.writeText(details)
            .then(() => utils.showNotification('Detalhes copiados para a área de transferência!', 'success'))
            .catch(() => utils.showNotification('Erro ao copiar detalhes.', 'error'));
    }
}

// Inicialização da aplicação
document.addEventListener('DOMContentLoaded', () => {
    window.noteManager = new NoteManager();
});

// Garantia de inicialização
setTimeout(() => {
    if (!window.noteManager) {
        window.noteManager = new NoteManager();
    }
}, 1000);
</script>
</body>
</html>
