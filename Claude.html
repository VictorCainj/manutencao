<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Anotações de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .btn {
            @apply px-4 py-2 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-colors duration-200;
        }
        .btn-blue {
            @apply bg-blue-500 hover:bg-blue-700 focus:ring-blue-400;
        }
        .btn-green {
            @apply bg-green-500 hover:bg-green-700 focus:ring-green-400;
        }
        .btn-yellow {
            @apply bg-yellow-500 hover:bg-yellow-700 focus:ring-yellow-400;
        }
        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-700 focus:ring-gray-400;
        }
        .btn-red {
            @apply bg-red-500 hover:bg-red-700 focus:ring-red-400;
        }
        .btn-orange {
            @apply bg-orange-500 hover:bg-orange-700 focus:ring-orange-400;
        }
        .notification {
            @apply fixed top-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 ease-in-out z-50 font-semibold;
            animation: slideIn 0.3s ease-out;
        }
        .notification-success {
            @apply bg-green-500 text-white border-l-4 border-green-700;
        }
        .notification-error {
            @apply bg-red-500 text-white border-l-4 border-red-700;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 z-40;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-lg transform transition-all duration-300;
        }
        .comment-box {
            @apply bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 mb-4;
        }
        .note-card {
            @apply transition-all duration-200 transform hover:scale-102;
        }
        .progress-bar {
            @apply absolute bottom-0 left-0 h-2 bg-blue-500 transition-all duration-300;
        }
        .date-input {
            @apply px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
    <!-- Debug Info -->
    <div id="debugInfo" class="fixed bottom-4 right-4 bg-gray-800 text-white p-2 rounded-md text-xs opacity-50 hover:opacity-100">
        <div>Data: 2025-01-24 00:39:46</div>
        <div>Usuário: VictorCainj</div>
    </div>

    <!-- Notification Component -->
    <div id="notification" class="notification hidden"></div>

    <!-- Loading Spinner with Progress Bar -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center hidden z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        <div class="w-64 h-2 mt-4 bg-gray-200 rounded-full overflow-hidden">
            <div class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="mb-6 space-x-4">
        <button id="createNoteBtn" class="btn btn-blue">
            <i class="fas fa-plus mr-2"></i>Criar anotação
        </button>
        <button id="importNotesBtn" class="btn btn-green">
            <i class="fas fa-file-import mr-2"></i>Importar Contratos
        </button>
        <button id="downloadNotesBtn" class="btn btn-yellow">
            <i class="fas fa-download mr-2"></i>Baixar Todos os Contratos
        </button>
        <input type="file" id="fileInput" class="hidden" accept=".json">
    </div>

    <!-- Search and Filter Controls -->
    <div class="mb-6 w-full max-w-4xl space-y-4">
        <div class="relative">
            <input type="text" 
                   id="searchInput" 
                   placeholder="Pesquisar contratos..." 
                   class="w-full px-4 py-2 pl-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                   aria-label="Pesquisar contratos">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>

        <div class="flex space-x-4 items-center">
            <select id="dateSort" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="newest">Mais recentes primeiro</option>
                <option value="oldest">Mais antigos primeiro</option>
            </select>
            <select id="statusFilter" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="all">Todos os status</option>
                <option value="open">Abertos</option>
                <option value="scheduled">Em agendamento</option>
                <option value="closed">Fechados</option>
            </select>
        </div>
    </div>

    <!-- Note Creation Modal -->
    <div id="noteModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-center">Criar Anotação</h2>
            <form id="noteForm" class="space-y-4">
                <div>
                    <label for="contractNumber" class="block text-gray-700">Número de Contrato: *</label>
                    <input type="text" 
                           id="contractNumber" 
                           required
                           pattern="[A-Za-z0-9-]+"
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label for="locator" class="block text-gray-700">Locador: *</label>
                    <input type="text" 
                           id="locator" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label for="tenant" class="block text-gray-700">Locatário: *</label>
                    <input type="text" 
                           id="tenant" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label for="problem" class="block text-gray-700">Problema: *</label>
                    <textarea id="problem" 
                             required
                             class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[100px]"></textarea>
                </div>

                <div>
                    <label for="creationDate" class="block text-gray-700">Data de Criação: *</label>
                    <input type="date" 
                           id="creationDate" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label for="address" class="block text-gray-700">Endereço: *</label>
                    <input type="text" 
                           id="address" 
                           required
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelBtn" class="btn btn-gray">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-blue">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Note Details Modal -->
    <div id="noteDetailsModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Detalhes da Anotação</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna da esquerda - Detalhes -->
                <div class="space-y-4">
                    <div id="noteDetailsContent" class="bg-white p-4 rounded-lg shadow-md"></div>
                    
                    <!-- Container para Agendamento -->
                    <div id="schedulingContainer" class="hidden space-y-4">
                        <div>
                            <label for="scheduleDate" class="block text-gray-700 mb-2">Data de Agendamento:</label>
                            <input type="date" 
                                   id="scheduleDate" 
                                   class="date-input w-full">
                        </div>
                        <div>
                            <label for="serviceProvider" class="block text-gray-700 mb-2">Prestador de Serviço:</label>
                            <input type="text" 
                                   id="serviceProvider" 
                                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                   placeholder="Nome do prestador de serviço">
                        </div>
                    </div>

                    <!-- Status Buttons -->
                    <div id="statusButtons" class="flex space-x-2">
                        <!-- Botões de status serão inseridos dinamicamente -->
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <button type="button" id="copyDetailsBtn" class="btn btn-green flex-1">
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                        <button type="button" id="downloadContractBtn" class="btn btn-yellow flex-1">
                            <i class="fas fa-file-download mr-2"></i>Baixar
                        </button>
                        <button type="button" id="deleteNoteBtn" class="btn btn-red flex-1">
                            <i class="fas fa-trash mr-2"></i>Excluir
                        </button>
                    </div>
                </div>

                <!-- Coluna da direita - Comentários -->
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Comentários</h3>
                        
                        <form id="commentForm" class="mb-4">
                            <textarea id="commentText" 
                                     required
                                     class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[80px]"
                                     placeholder="Digite seu comentário aqui..."
                                     data-prevent-blur="true"></textarea>
                            <button type="submit" class="btn btn-blue w-full mt-2">
                                <i class="fas fa-comment mr-2"></i>Adicionar Comentário
                            </button>
                        </form>

                        <div id="commentsContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-right">
                <button type="button" id="closeDetailsBtn" class="btn btn-gray">
                    <i class="fas fa-times mr-2"></i>Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Notes Container -->
    <div id="notesContainer" class="w-full max-w-4xl grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    </div>

<script>
// Utility Functions
const utils = {
    formatDate: (date, includeTime = false) => {
        if (!date) return '';
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const pad = (num) => String(num).padStart(2, '0');
        const dateStr = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        
        if (!includeTime) return dateStr;
        
        return `${dateStr} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },

    parseDateInput: (dateStr) => {
        if (!dateStr) return null;
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    },

    calculateDaysOpen: (startDate) => {
        if (!startDate) return 0;
        const start = new Date(startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    },

    showNotification: (message, type = 'success') => {
        const notification = document.getElementById('notification');
        notification.className = `notification ${type === 'success' ? 'notification-success' : 'notification-error'}`;
        notification.textContent = message;
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.add('hidden'), 3000);
    },

    showLoading: (show = true, progress = 0) => {
        const spinner = document.getElementById('loadingSpinner');
        const progressBar = spinner.querySelector('.progress-bar');
        spinner.classList.toggle('hidden', !show);
        if (show && progressBar) {
            progressBar.style.width = `${progress}%`;
        }
    },

    sanitizeInput: (input) => {
        if (typeof input !== 'string') return '';
        return input.trim()
                   .replace(/[<>]/g, '')
                   .replace(/&/g, '&amp;')
                   .replace(/"/g, '&quot;')
                   .replace(/'/g, '&#39;');
    },

    debug: (message) => {
        console.log(`[${new Date().toISOString()}] ${message}`);
        // Atualiza o debugInfo se existir
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            const newDebugMessage = document.createElement('div');
            newDebugMessage.textContent = message;
            debugInfo.appendChild(newDebugMessage);
            // Mantém apenas as últimas 5 mensagens
            while (debugInfo.children.length > 7) {
                debugInfo.removeChild(debugInfo.children[2]);
            }
        }
    }
};
    class NoteManager {
    constructor() {
        // Verifica se já existe uma instância
        if (window.noteManager) {
            utils.debug('NoteManager já foi inicializado - retornando instância existente');
            return window.noteManager;
        }

        this.notes = {};
        this.currentUser = 'VictorCainj';
        this.currentDateTime = '2025-01-24 00:41:11';
        
        // Garante que o DOM está carregado antes de inicializar
        if (document.readyState === 'loading') {
            utils.debug('DOM ainda carregando - aguardando DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', () => this.initialize());
        } else {
            utils.debug('DOM já carregado - inicializando imediatamente');
            this.initialize();
        }

        // Atribui a instância à window
        window.noteManager = this;
    }

    initialize() {
        utils.debug('Iniciando inicialização do NoteManager');
        this.loadFromLocalStorage();
        this.cleanInvalidNotes();
        this.initializeEventListeners();
        this.activeNoteKey = null;
        utils.debug('NoteManager inicializado com sucesso');
    }

    initializeEventListeners() {
        utils.debug('Configurando event listeners');
        
        // Mapeamento de elementos e seus event listeners
        const elementHandlers = {
            'createNoteBtn': {
                event: 'click',
                handler: () => {
                    utils.debug('Botão criar nota clicado');
                    const noteModal = document.getElementById('noteModal');
                    const contractNumber = document.getElementById('contractNumber');
                    const creationDate = document.getElementById('creationDate');
                    
                    noteModal.classList.remove('hidden');
                    contractNumber.focus();
                    creationDate.valueAsDate = new Date();
                }
            },
            'cancelBtn': {
                event: 'click',
                handler: () => {
                    utils.debug('Botão cancelar clicado');
                    document.getElementById('noteModal').classList.add('hidden');
                    document.getElementById('noteForm').reset();
                }
            },
            'noteForm': {
                event: 'submit',
                handler: (e) => {
                    e.preventDefault();
                    utils.debug('Formulário de nota submetido');
                    this.handleFormSubmit();
                }
            },
            'searchInput': {
                event: 'input',
                handler: (e) => {
                    utils.debug('Busca sendo realizada');
                    this.handleSearch(e.target.value);
                }
            },
            'dateSort': {
                event: 'change',
                handler: () => {
                    utils.debug('Ordenação alterada');
                    this.filterAndSortNotes();
                }
            },
            'statusFilter': {
                event: 'change',
                handler: () => {
                    utils.debug('Filtro de status alterado');
                    this.filterAndSortNotes();
                }
            },
            'importNotesBtn': {
                event: 'click',
                handler: () => {
                    utils.debug('Botão importar clicado');
                    document.getElementById('fileInput').click();
                }
            },
            'fileInput': {
                event: 'change',
                handler: (e) => {
                    utils.debug('Arquivo selecionado para importação');
                    this.handleFileImport(e);
                }
            },
            'downloadNotesBtn': {
                event: 'click',
                handler: () => {
                    utils.debug('Botão download clicado');
                    this.exportAllNotes();
                }
            }
        };

        // Configuração dos event listeners com verificação de existência
        for (const [elementId, config] of Object.entries(elementHandlers)) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(config.event, config.handler);
                utils.debug(`Event listener configurado para: ${elementId}`);
            } else {
                utils.debug(`ERRO: Elemento não encontrado: ${elementId}`);
            }
        }

        // Event listener global para ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                utils.debug('Tecla ESC pressionada');
                document.getElementById('noteModal').classList.add('hidden');
                document.getElementById('noteDetailsModal').classList.add('hidden');
                this.activeNoteKey = null;
            }
        });

        utils.debug('Todos os event listeners configurados');
    }
        loadFromLocalStorage() {
        try {
            utils.debug('Carregando dados do localStorage');
            const savedNotes = localStorage.getItem('notes');
            if (savedNotes) {
                this.notes = JSON.parse(savedNotes);
                utils.debug(`${Object.keys(this.notes).length} notas carregadas`);
            } else {
                utils.debug('Nenhuma nota encontrada no localStorage');
            }
        } catch (error) {
            utils.debug(`ERRO ao carregar do localStorage: ${error.message}`);
            this.notes = {};
        }
    }

    saveToLocalStorage() {
        try {
            utils.debug('Salvando dados no localStorage');
            localStorage.setItem('notes', JSON.stringify(this.notes));
            utils.debug('Dados salvos com sucesso');
        } catch (error) {
            utils.debug(`ERRO ao salvar no localStorage: ${error.message}`);
            utils.showNotification('Erro ao salvar dados localmente', 'error');
        }
    }

    handleFormSubmit() {
        utils.debug('Processando submissão do formulário');
        
        const formData = {
            contractNumber: document.getElementById('contractNumber').value,
            locator: document.getElementById('locator').value,
            tenant: document.getElementById('tenant').value,
            problem: document.getElementById('problem').value,
            address: document.getElementById('address').value,
            createdAt: document.getElementById('creationDate').value
        };

        utils.debug('Dados do formulário coletados:', formData);

        const errors = this.validateForm(formData);
        if (errors.length > 0) {
            utils.debug(`Erros de validação encontrados: ${errors.join(', ')}`);
            utils.showNotification(errors.join('\n'), 'error');
            return;
        }

        const success = this.addNote(formData);
        if (success) {
            utils.debug('Nota adicionada com sucesso');
            document.getElementById('noteForm').reset();
            document.getElementById('noteModal').classList.add('hidden');
            this.filterAndSortNotes();
            utils.showNotification('Anotação criada com sucesso!', 'success');
        }
    }

    validateForm(formData) {
        utils.debug('Validando dados do formulário');
        const errors = [];
        
        const validations = {
            contractNumber: {
                test: value => /^[A-Za-z0-9-]+$/.test(value),
                message: 'Número de contrato inválido - use apenas letras, números e hífen'
            },
            locator: {
                test: value => value.length >= 3,
                message: 'Nome do Locador deve ter ao menos 3 caracteres'
            },
            tenant: {
                test: value => value.length >= 3,
                message: 'Nome do Locatário deve ter ao menos 3 caracteres'
            },
            problem: {
                test: value => value.length >= 10,
                message: 'Problema deve ter ao menos 10 caracteres'
            },
            address: {
                test: value => value.length >= 5,
                message: 'Endereço deve ter ao menos 5 caracteres'
            },
            createdAt: {
                test: value => Boolean(value),
                message: 'Data de criação é obrigatória'
            }
        };

        for (const [field, validation] of Object.entries(validations)) {
            if (!validation.test(formData[field])) {
                utils.debug(`Erro de validação em ${field}: ${validation.message}`);
                errors.push(validation.message);
            }
        }
        
        utils.debug(`Validação concluída. ${errors.length} erros encontrados`);
        return errors;
    }

    addNote(formData) {
        try {
            utils.debug('Iniciando adição de nova nota');
            
            const sanitizedData = {
                contractNumber: utils.sanitizeInput(formData.contractNumber),
                locator: utils.sanitizeInput(formData.locator),
                tenant: utils.sanitizeInput(formData.tenant),
                problem: utils.sanitizeInput(formData.problem),
                address: utils.sanitizeInput(formData.address),
                createdAt: formData.createdAt
            };

            if (!sanitizedData.contractNumber) {
                throw new Error('Número do contrato é obrigatório');
            }

            const existingNotes = Object.keys(this.notes).filter(key => 
                key.startsWith(sanitizedData.contractNumber + '#'));
            
            const sequence = existingNotes.length + 1;
            const noteKey = `${sanitizedData.contractNumber}#${sequence}`;

            utils.debug(`Criando nota com chave: ${noteKey}`);

            this.notes[noteKey] = {
                ...sanitizedData,
                status: 'open',
                comments: [],
                createdBy: this.currentUser,
                scheduleDate: null,
                serviceProvider: null
            };

            this.renderNote(noteKey);
            this.saveToLocalStorage();
            
            utils.debug('Nota adicionada com sucesso');
            return true;
        } catch (error) {
            utils.debug(`ERRO ao adicionar nota: ${error.message}`);
            utils.showNotification(`Erro ao criar anotação: ${error.message}`, 'error');
            return false;
        }
    }
        handleCommentSubmit() {
        utils.debug('Iniciando submissão de comentário');
        
        const commentText = document.getElementById('commentText');
        const text = commentText.value.trim();
        
        if (!text || !this.activeNoteKey) {
            utils.debug('Comentário vazio ou nenhuma nota ativa');
            return;
        }

        const note = this.notes[this.activeNoteKey];
        if (!note) {
            utils.debug('Nota não encontrada');
            return;
        }

        if (!Array.isArray(note.comments)) {
            utils.debug('Inicializando array de comentários');
            note.comments = [];
        }

        const comment = {
            id: Date.now().toString(),
            text: utils.sanitizeInput(text),
            dateTime: this.currentDateTime,
            editedAt: null
        };

        utils.debug('Adicionando novo comentário');
        note.comments.push(comment);
        this.saveToLocalStorage();
        this.renderComments(this.activeNoteKey);
        commentText.value = '';
        commentText.focus();
        
        utils.showNotification('Comentário adicionado com sucesso!', 'success');
        utils.debug('Comentário adicionado com sucesso');
    }

    renderComments(noteKey) {
        utils.debug(`Renderizando comentários para nota: ${noteKey}`);
        
        const commentsContainer = document.getElementById('commentsContainer');
        const note = this.notes[noteKey];

        if (!note || !commentsContainer) {
            utils.debug('Nota ou container de comentários não encontrado');
            return;
        }

        commentsContainer.innerHTML = '';

        if (!note.comments || note.comments.length === 0) {
            utils.debug('Nenhum comentário encontrado');
            commentsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    Nenhum comentário ainda. Seja o primeiro a comentar!
                </div>`;
            return;
        }

        utils.debug(`Renderizando ${note.comments.length} comentários`);
        note.comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-box';
            commentElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow">
                        <p class="whitespace-pre-wrap">${utils.sanitizeInput(comment.text)}</p>
                        <div class="text-sm text-gray-500 mt-2">
                            ${utils.formatDate(comment.dateTime, true)}
                            ${comment.editedAt ? `<span class="italic">(editado em ${utils.formatDate(comment.editedAt, true)})</span>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button class="text-blue-500 hover:text-blue-700" onclick="noteManager.editComment('${noteKey}', '${comment.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700" onclick="noteManager.deleteComment('${noteKey}', '${comment.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            commentsContainer.appendChild(commentElement);
        });

        utils.debug('Comentários renderizados com sucesso');
    }

    editComment(noteKey, commentId) {
        utils.debug(`Iniciando edição do comentário: ${commentId}`);
        
        const note = this.notes[noteKey];
        const comment = note.comments.find(c => c.id === commentId);
        
        if (!comment) {
            utils.debug('Comentário não encontrado');
            return;
        }

        const newText = prompt('Editar comentário:', comment.text);
        if (newText !== null && newText.trim() !== '') {
            utils.debug('Atualizando comentário');
            comment.text = utils.sanitizeInput(newText.trim());
            comment.editedAt = this.currentDateTime;
            
            this.saveToLocalStorage();
            this.renderComments(noteKey);
            utils.showNotification('Comentário atualizado com sucesso!', 'success');
            utils.debug('Comentário atualizado com sucesso');
        }
    }

    deleteComment(noteKey, commentId) {
        utils.debug(`Iniciando exclusão do comentário: ${commentId}`);
        
        if (confirm('Tem certeza que deseja excluir este comentário?')) {
            const note = this.notes[noteKey];
            const commentIndex = note.comments.findIndex(c => c.id === commentId);
            
            if (commentIndex !== -1) {
                utils.debug('Removendo comentário');
                note.comments.splice(commentIndex, 1);
                this.saveToLocalStorage();
                this.renderComments(noteKey);
                utils.showNotification('Comentário excluído com sucesso!', 'success');
                utils.debug('Comentário excluído com sucesso');
            }
        }
    }
        filterAndSortNotes() {
        utils.debug('Iniciando filtragem e ordenação de notas');
        
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sortOrder = document.getElementById('dateSort').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        utils.debug(`Parâmetros: busca="${searchTerm}", ordem="${sortOrder}", status="${statusFilter}"`);

        const notes = document.querySelectorAll('.note-button');
        let visibleCount = 0;

        notes.forEach(note => {
            const noteData = {
                contract: note.dataset.contract.toLowerCase(),
                locator: note.dataset.locator,
                tenant: note.dataset.tenant,
                address: note.dataset.address,
                status: note.dataset.status,
                date: note.dataset.date
            };

            const matchesSearch = 
                noteData.contract.includes(searchTerm) ||
                noteData.locator.includes(searchTerm) ||
                noteData.tenant.includes(searchTerm) ||
                noteData.address.includes(searchTerm);

            const matchesStatus = statusFilter === 'all' || noteData.status === statusFilter;

            const isVisible = matchesSearch && matchesStatus;
            note.classList.toggle('hidden', !isVisible);
            
            if (isVisible) visibleCount++;
        });

        utils.debug(`${visibleCount} notas visíveis após filtragem`);

        // Ordenação
        const notesContainer = document.getElementById('notesContainer');
        const notesArray = Array.from(notes);

        notesArray.sort((a, b) => {
            const dateA = new Date(a.dataset.date);
            const dateB = new Date(b.dataset.date);
            return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
        });

        utils.debug('Reordenando notas no DOM');
        notesArray.forEach(note => notesContainer.appendChild(note));

        // Mensagem de nenhum resultado
        const existingMessage = notesContainer.querySelector('.no-results-message');
        if (existingMessage) {
            existingMessage.remove();
        }

        if (visibleCount === 0) {
            utils.debug('Nenhuma nota encontrada, exibindo mensagem');
            const message = document.createElement('div');
            message.className = 'no-results-message col-span-full text-center text-gray-500 py-8';
            message.textContent = 'Nenhuma anotação encontrada para os filtros selecionados.';
            notesContainer.appendChild(message);
        }
    }

    updateScheduleInfo(noteKey) {
        utils.debug(`Atualizando informações de agendamento para nota: ${noteKey}`);
        
        if (!noteKey || !this.notes[noteKey]) {
            utils.debug('Nota não encontrada');
            return;
        }

        const note = this.notes[noteKey];
        const scheduleDate = document.getElementById('scheduleDate').value;
        const serviceProvider = document.getElementById('serviceProvider').value;

        const currentValues = {
            scheduleDate: note.scheduleDate,
            serviceProvider: note.serviceProvider
        };

        const newValues = {
            scheduleDate,
            serviceProvider
        };

        if (JSON.stringify(currentValues) !== JSON.stringify(newValues)) {
            utils.debug('Detectadas alterações nas informações de agendamento');
            
            note.scheduleDate = scheduleDate;
            note.serviceProvider = serviceProvider;
            
            this.saveToLocalStorage();
            this.renderNote(noteKey);
            
            // Atualiza os detalhes sem reabrir o modal
            const detailsContent = document.getElementById('noteDetailsContent');
            const statusSpan = detailsContent.querySelector('span.font-semibold');
            if (statusSpan) {
                const statusText = note.status === 'scheduled' ? 
                    `Agendado para ${utils.formatDate(note.scheduleDate)}${note.serviceProvider ? `\nPrestador: ${note.serviceProvider}` : ''}` : 
                    'Em agendamento';
                statusSpan.textContent = statusText;
            }

            utils.showNotification('Informações de agendamento atualizadas!', 'success');
            utils.debug('Informações de agendamento atualizadas com sucesso');
        } else {
            utils.debug('Nenhuma alteração detectada nas informações de agendamento');
        }
    }
        copyNoteDetails(noteKey) {
        utils.debug(`Iniciando cópia dos detalhes da nota: ${noteKey}`);
        
        const note = this.notes[noteKey];
        if (!note) {
            utils.debug('Nota não encontrada');
            utils.showNotification('Erro: Nota não encontrada', 'error');
            return;
        }

        try {
            const statusText = {
                'open': 'Aberto',
                'scheduled': note.scheduleDate ? 
                    `Agendado para ${utils.formatDate(note.scheduleDate)}${note.serviceProvider ? `\nPrestador: ${note.serviceProvider}` : ''}` : 
                    'Em agendamento',
                'closed': 'Finalizado'
            };

            let copyText = [
                `Contrato: ${note.contractNumber}`,
                `Locador: ${note.locator}`,
                `Locatário: ${note.tenant}`,
                `Problema: ${note.problem}`,
                `Endereço: ${note.address}`,
                `Status: ${statusText[note.status]}`,
                `Data de Criação: ${utils.formatDate(note.createdAt)}`,
                note.closedAt ? `Data de Fechamento: ${utils.formatDate(note.closedAt)}` : '',
                `\nComentários (${note.comments?.length || 0}):`
            ].filter(Boolean).join('\n');

            // Adiciona comentários se existirem
            if (note.comments && note.comments.length > 0) {
                copyText += '\n' + note.comments.map(comment => 
                    `\n[${utils.formatDate(comment.dateTime, true)}]${comment.editedAt ? ' (editado)' : ''}\n${comment.text}`
                ).join('\n');
            } else {
                copyText += '\nNenhum comentário registrado.';
            }

            navigator.clipboard.writeText(copyText).then(() => {
                utils.debug('Detalhes copiados com sucesso');
                utils.showNotification('Detalhes copiados para a área de transferência!', 'success');
            }).catch(err => {
                throw new Error(`Erro ao copiar para área de transferência: ${err.message}`);
            });
        } catch (error) {
            utils.debug(`ERRO ao copiar detalhes: ${error.message}`);
            utils.showNotification('Erro ao copiar detalhes', 'error');
        }
    }

    exportNote(noteKey) {
        utils.debug(`Iniciando exportação da nota: ${noteKey}`);
        
        try {
            const note = this.notes[noteKey];
            if (!note) {
                throw new Error('Nota não encontrada');
            }

            const exportData = {};
            exportData[noteKey] = note;
            
            const fileName = `contrato_${noteKey.replace('#', '_')}_${this.currentDateTime.replace(/[/: ]/g, '-')}.json`;
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);

            utils.debug('Nota exportada com sucesso');
            utils.showNotification('Contrato exportado com sucesso!', 'success');
        } catch (error) {
            utils.debug(`ERRO ao exportar nota: ${error.message}`);
            utils.showNotification('Erro ao exportar contrato', 'error');
        }
    }

    exportAllNotes() {
        utils.debug('Iniciando exportação de todas as notas');
        
        try {
            const fileName = `todos_contratos_${this.currentDateTime.replace(/[/: ]/g, '-')}.json`;
            const dataStr = JSON.stringify(this.notes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);

            utils.debug('Todas as notas exportadas com sucesso');
            utils.showNotification('Todos os contratos exportados com sucesso!', 'success');
        } catch (error) {
            utils.debug(`ERRO ao exportar todas as notas: ${error.message}`);
            utils.showNotification('Erro ao exportar contratos', 'error');
        }
    }
        handleFileImport(event) {
        utils.debug('Iniciando processo de importação de arquivo');
        
        const file = event.target.files[0];
        if (!file) {
            utils.debug('Nenhum arquivo selecionado');
            return;
        }

        utils.debug(`Arquivo selecionado: ${file.name}`);
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                utils.debug('Lendo conteúdo do arquivo');
                const importedData = JSON.parse(e.target.result);
                let importCount = 0;
                let skipCount = 0;

                for (const [key, note] of Object.entries(importedData)) {
                    if (this.notes[key]) {
                        utils.debug(`Nota ${key} já existe - pulando`);
                        skipCount++;
                        continue;
                    }

                    // Validação básica da estrutura da nota
                    if (!this.validateImportedNote(note)) {
                        utils.debug(`Nota ${key} inválida - pulando`);
                        skipCount++;
                        continue;
                    }

                    this.notes[key] = note;
                    this.renderNote(key);
                    importCount++;
                    utils.debug(`Nota ${key} importada com sucesso`);
                }

                this.saveToLocalStorage();
                
                const message = `Importação concluída!\n${importCount} notas importadas.\n${skipCount} notas ignoradas.`;
                utils.debug(message);
                utils.showNotification(message, 'success');
            } catch (error) {
                utils.debug(`ERRO durante importação: ${error.message}`);
                utils.showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
            }
        };

        reader.onerror = (error) => {
            utils.debug(`ERRO ao ler arquivo: ${error}`);
            utils.showNotification('Erro ao ler arquivo', 'error');
        };

        reader.readAsText(file);
        event.target.value = ''; // Limpa o input para permitir importar o mesmo arquivo novamente
    }

    validateImportedNote(note) {
        utils.debug('Validando nota importada');
        
        const requiredFields = [
            'contractNumber',
            'locator',
            'tenant',
            'problem',
            'address',
            'createdAt',
            'status'
        ];

        const isValid = requiredFields.every(field => {
            const hasField = note.hasOwnProperty(field) && note[field] !== null && note[field] !== undefined;
            if (!hasField) {
                utils.debug(`Campo obrigatório ausente: ${field}`);
            }
            return hasField;
        });

        // Validação adicional de status
        if (isValid && !['open', 'scheduled', 'closed'].includes(note.status)) {
            utils.debug(`Status inválido: ${note.status}`);
            return false;
        }

        utils.debug(`Validação da nota: ${isValid ? 'válida' : 'inválida'}`);
        return isValid;
    }

    cleanInvalidNotes() {
        utils.debug('Iniciando limpeza de notas inválidas');
        
        const initialCount = Object.keys(this.notes).length;
        let cleanedCount = 0;

        for (const [key, note] of Object.entries(this.notes)) {
            if (!this.validateImportedNote(note)) {
                delete this.notes[key];
                cleanedCount++;
                utils.debug(`Nota inválida removida: ${key}`);
            }
        }

        if (cleanedCount > 0) {
            this.saveToLocalStorage();
            utils.debug(`${cleanedCount} notas inválidas removidas de ${initialCount} notas totais`);
        } else {
            utils.debug('Nenhuma nota inválida encontrada');
        }
    }
}

// Inicialização da aplicação
document.addEventListener('DOMContentLoaded', () => {
    utils.debug('DOM carregado - inicializando aplicação');
    window.noteManager = new NoteManager();
});

// Garantia de inicialização
setTimeout(() => {
    if (!window.noteManager) {
        utils.debug('Reinicializando noteManager após timeout');
        window.noteManager = new NoteManager();
    }
}, 1000);
</script>
</body>
</html>
