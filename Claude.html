<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Anotações de Contratos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <!-- Container Principal -->
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-8">Sistema de Anotações de Contratos</h1>
        
        <!-- Barra de Ferramentas -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="createNoteBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                <i class="fas fa-plus mr-2"></i>Nova Anotação
            </button>
            <button id="importNotesBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                <i class="fas fa-file-import mr-2"></i>Importar
            </button>
            <button id="downloadNotesBtn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                <i class="fas fa-download mr-2"></i>Exportar Todos
            </button>
        </div>

        <!-- Barra de Busca e Filtros -->
        <div class="mb-6">
            <input type="text" 
                   id="searchInput" 
                   placeholder="Pesquisar contratos..." 
                   class="w-full p-2 border rounded mb-2">
            <div class="flex gap-4">
                <select id="dateSort" class="p-2 border rounded">
                    <option value="newest">Mais recentes</option>
                    <option value="oldest">Mais antigos</option>
                </select>
                <select id="statusFilter" class="p-2 border rounded">
                    <option value="all">Todos os status</option>
                    <option value="open">Abertos</option>
                    <option value="scheduled">Agendados</option>
                    <option value="closed">Fechados</option>
                </select>
            </div>
        </div>

        <!-- Container de Notas -->
        <div id="notesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- As notas serão inseridas aqui dinamicamente -->
        </div>

        <!-- Modal de Nova Anotação -->
        <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
            <div class="bg-white p-6 rounded-lg max-w-md mx-auto mt-20">
                <h2 class="text-xl font-bold mb-4">Nova Anotação</h2>
                <form id="noteForm">
                    <!-- Campos do formulário serão adicionados aqui -->
                </form>
            </div>
        </div>

        <!-- Modal de Detalhes -->
        <div id="noteDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
            <div class="bg-white p-6 rounded-lg max-w-4xl mx-auto mt-20">
                <!-- Conteúdo dos detalhes será adicionado aqui -->
            </div>
        </div>

        <!-- Input file oculto para importação -->
        <input type="file" id="fileInput" class="hidden" accept=".json">
    </div>

    <!-- Notificação -->
    <div id="notification" class="fixed top-4 right-4 hidden"></div>

</body>
</html>

<!-- Adicionar logo após o título no head, antes do Tailwind CSS -->
<style>
    .btn {
        @apply px-4 py-2 rounded-md transition-colors duration-200 flex items-center justify-center;
    }
    
    .btn-blue {
        @apply bg-blue-500 text-white hover:bg-blue-600;
    }
    
    .btn-green {
        @apply bg-green-500 text-white hover:bg-green-600;
    }
    
    .btn-yellow {
        @apply bg-yellow-500 text-white hover:bg-yellow-600;
    }
    
    .btn-red {
        @apply bg-red-500 text-white hover:bg-red-600;
    }
    
    .btn-gray {
        @apply bg-gray-500 text-white hover:bg-gray-600;
    }

    .note-card {
        @apply bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer;
    }

    .comment-box {
        @apply bg-gray-50 p-4 rounded-lg mb-4;
    }

    .modal-overlay {
        @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
    }

    .modal-content {
        @apply bg-white rounded-lg shadow-xl max-h-[90vh] overflow-y-auto;
    }

    .notification {
        @apply fixed top-4 right-4 px-6 py-3 rounded-md text-white z-50 transition-all duration-300 transform;
    }

    .notification-success {
        @apply bg-green-500;
    }

    .notification-error {
        @apply bg-red-500;
    }

    .progress-bar {
        @apply h-full bg-blue-500 transition-all duration-300;
    }
</style>

<!-- Adicionar logo antes do fechamento do body -->
<script>
// Configuração inicial do Tailwind
tailwind.config = {
    theme: {
        extend: {
            zIndex: {
                '100': '100',
            }
        }
    }
}

// Utilitários básicos
const utils = {
    formatDate: (date, includeTime = false) => {
        if (!date) return '';
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const pad = (num) => String(num).padStart(2, '0');
        const dateStr = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        
        if (!includeTime) return dateStr;
        return `${dateStr} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    },

    showNotification: (message, type = 'success') => {
        const notification = document.getElementById('notification');
        if (!notification) return;

        notification.textContent = message;
        notification.className = `notification ${type === 'success' ? 'notification-success' : 'notification-error'}`;
        notification.classList.remove('hidden');

        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }
};

// Garantir que o DOM está carregado antes de inicializar
document.addEventListener('DOMContentLoaded', () => {
    // Teste inicial para verificar se os elementos estão sendo encontrados
    const createNoteBtn = document.getElementById('createNoteBtn');
    if (createNoteBtn) {
        createNoteBtn.addEventListener('click', () => {
            const modal = document.getElementById('noteModal');
            if (modal) {
                modal.classList.remove('hidden');
                utils.showNotification('Modal aberto com sucesso!', 'success');
            } else {
                console.error('Modal não encontrado');
            }
        });
    } else {
        console.error('Botão de criar nota não encontrado');
    }
});
</script>

<!-- Atualizar o modal de nova anotação dentro do body -->
<div id="noteModal" class="modal-overlay hidden">
    <div class="modal-content p-6 w-full max-w-2xl">
        <h2 class="text-2xl font-semibold mb-4">Nova Anotação</h2>
        <form id="noteForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="contractNumber" class="block text-gray-700 mb-2">Número do Contrato*</label>
                    <input type="text" 
                           id="contractNumber" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           required
                           placeholder="Ex: CT12345">
                </div>
                <div>
                    <label for="creationDate" class="block text-gray-700 mb-2">Data de Criação*</label>
                    <input type="date" 
                           id="creationDate" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           required>
                </div>
                <div>
                    <label for="locator" class="block text-gray-700 mb-2">Locador*</label>
                    <input type="text" 
                           id="locator" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           required
                           placeholder="Nome do locador">
                </div>
                <div>
                    <label for="tenant" class="block text-gray-700 mb-2">Locatário*</label>
                    <input type="text" 
                           id="tenant" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           required
                           placeholder="Nome do locatário">
                </div>
                <div class="col-span-full">
                    <label for="address" class="block text-gray-700 mb-2">Endereço*</label>
                    <input type="text" 
                           id="address" 
                           class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                           required
                           placeholder="Endereço completo">
                </div>
                <div class="col-span-full">
                    <label for="problem" class="block text-gray-700 mb-2">Problema*</label>
                    <textarea id="problem" 
                              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[100px]"
                              required
                              placeholder="Descreva o problema"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" 
                        id="cancelBtn"
                        class="btn btn-gray">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="submit" 
                        class="btn btn-blue">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Adicionar antes do fechamento do body -->
<script>
// Inicialização do formulário
document.addEventListener('DOMContentLoaded', () => {
    const noteForm = document.getElementById('noteForm');
    const noteModal = document.getElementById('noteModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const createNoteBtn = document.getElementById('createNoteBtn');
    const creationDate = document.getElementById('creationDate');

    // Configurar data atual no campo de data
    const today = new Date().toISOString().split('T')[0];
    if (creationDate) {
        creationDate.value = today;
        creationDate.max = today;
    }

    // Abrir modal
    if (createNoteBtn) {
        createNoteBtn.addEventListener('click', () => {
            if (noteModal) {
                noteModal.classList.remove('hidden');
                document.getElementById('contractNumber')?.focus();
            }
        });
    }

    // Fechar modal
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (noteModal) {
                noteModal.classList.add('hidden');
                noteForm?.reset();
            }
        });
    }

    // Fechar modal com ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && noteModal) {
            noteModal.classList.add('hidden');
            noteForm?.reset();
        }
    });

    // Submeter formulário
    if (noteForm) {
        noteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Coletar dados do formulário
            const formData = {
                contractNumber: document.getElementById('contractNumber')?.value.trim(),
                creationDate: document.getElementById('creationDate')?.value,
                locator: document.getElementById('locator')?.value.trim(),
                tenant: document.getElementById('tenant')?.value.trim(),
                address: document.getElementById('address')?.value.trim(),
                problem: document.getElementById('problem')?.value.trim()
            };

            // Validar dados
            if (Object.values(formData).some(value => !value)) {
                utils.showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }

            // Salvar nota (temporário até implementarmos o NoteManager)
            console.log('Dados do formulário:', formData);
            utils.showNotification('Nota criada com sucesso!', 'success');
            
            // Fechar modal e limpar formulário
            noteModal.classList.add('hidden');
            noteForm.reset();
        });
    }
});
</script>

// Adicionar antes do fechamento do body, após o script anterior
<script>
// Classe NoteManager - Gerenciamento das notas
class NoteManager {
    constructor() {
        // Singleton pattern
        if (window.noteManager) {
            return window.noteManager;
        }

        this.notes = {};
        this.currentUser = 'VictorCainj';
        this.currentDateTime = '2025-01-24 01:03:14';
        
        this.initialize();
        window.noteManager = this;
    }

    initialize() {
        this.loadFromLocalStorage();
        this.initializeEventListeners();
        this.renderAllNotes();
    }

    loadFromLocalStorage() {
        try {
            const savedNotes = localStorage.getItem('notes');
            this.notes = savedNotes ? JSON.parse(savedNotes) : {};
        } catch (error) {
            console.error('Erro ao carregar notas:', error);
            this.notes = {};
        }
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem('notes', JSON.stringify(this.notes));
        } catch (error) {
            utils.showNotification('Erro ao salvar notas. Verifique o espaço disponível.', 'error');
        }
    }

    renderAllNotes() {
        const container = document.getElementById('notesContainer');
        if (!container) return;

        container.innerHTML = '';
        
        if (Object.keys(this.notes).length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center text-gray-500 py-8">
                    Nenhuma anotação encontrada. Clique em "Nova Anotação" para começar!
                </div>
            `;
            return;
        }

        // Ordenar notas por data de criação (mais recentes primeiro)
        const sortedNotes = Object.entries(this.notes)
            .sort(([, a], [, b]) => new Date(b.createdAt) - new Date(a.createdAt));

        sortedNotes.forEach(([key, note]) => {
            this.renderNote(key);
        });
    }

    renderNote(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        const container = document.getElementById('notesContainer');
        if (!container) return;

        const noteElement = document.createElement('div');
        noteElement.className = 'note-card';
        noteElement.setAttribute('data-note-key', noteKey);

        const statusColors = {
            'open': 'text-blue-600',
            'scheduled': 'text-orange-600',
            'closed': 'text-green-600'
        };

        const statusIcons = {
            'open': 'fa-folder-open',
            'scheduled': 'fa-calendar-alt',
            'closed': 'fa-check-circle'
        };

        noteElement.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-semibold text-lg">${utils.sanitizeInput(note.contractNumber)}</h3>
                <i class="fas ${statusIcons[note.status]} ${statusColors[note.status]}"></i>
            </div>
            <p class="text-sm text-gray-600 mb-1">${utils.sanitizeInput(note.locator)}</p>
            <p class="text-sm text-gray-600 mb-1">${utils.sanitizeInput(note.tenant)}</p>
            <p class="text-sm text-gray-500 truncate mb-2">${utils.sanitizeInput(note.address)}</p>
            <div class="text-xs text-gray-400">
                ${utils.formatDate(note.createdAt)}
            </div>
        `;

        noteElement.addEventListener('click', () => this.showNoteDetails(noteKey));
        container.appendChild(noteElement);
    }

    addNote(formData) {
        const noteKey = `#${formData.contractNumber}`;
        
        if (this.notes[noteKey]) {
            utils.showNotification('Já existe uma anotação com este número de contrato.', 'error');
            return false;
        }

        this.notes[noteKey] = {
            ...formData,
            status: 'open',
            comments: [],
            createdAt: new Date().toISOString(),
            closedAt: null
        };

        this.saveToLocalStorage();
        this.renderNote(noteKey);
        utils.showNotification('Anotação criada com sucesso!', 'success');
        return true;
    }

    // Função auxiliar para sanitizar input
    static sanitizeInput(text) {
        if (!text) return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
}

// Inicializar NoteManager
document.addEventListener('DOMContentLoaded', () => {
    // Atualizar manipulador de eventos do formulário
    const noteForm = document.getElementById('noteForm');
    if (noteForm) {
        noteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                contractNumber: document.getElementById('contractNumber').value.trim(),
                locator: document.getElementById('locator').value.trim(),
                tenant: document.getElementById('tenant').value.trim(),
                address: document.getElementById('address').value.trim(),
                problem: document.getElementById('problem').value.trim(),
                createdAt: new Date(document.getElementById('creationDate').value).toISOString()
            };

            const noteManager = new NoteManager();
            if (noteManager.addNote(formData)) {
                document.getElementById('noteModal').classList.add('hidden');
                noteForm.reset();
            }
        });
    }
});
</script>

// Adicionar antes do fechamento do body, após o script anterior
<script>
// Extensão da classe NoteManager com funcionalidades adicionais
class NoteManager {
    // ... (manter o código anterior da classe) ...

    showNoteDetails(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        const modal = document.getElementById('noteDetailsModal');
        if (!modal) return;

        this.activeNoteKey = noteKey;

        const statusText = {
            'open': 'Aberto',
            'scheduled': 'Agendado',
            'closed': 'Finalizado'
        };

        modal.innerHTML = `
            <div class="modal-content p-6 w-full max-w-4xl mx-auto mt-20">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-semibold">Detalhes da Anotação</h2>
                    <button id="closeDetailsBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold mb-2">Contrato: ${this.sanitizeInput(note.contractNumber)}</h3>
                        <p class="text-gray-600">Status: <span class="font-semibold">${statusText[note.status]}</span></p>
                        <p class="text-gray-600">Criado em: ${utils.formatDate(note.createdAt, true)}</p>
                        ${note.closedAt ? `<p class="text-gray-600">Fechado em: ${utils.formatDate(note.closedAt, true)}</p>` : ''}
                    </div>

                    <div class="space-y-2">
                        <p><span class="font-semibold">Locador:</span> ${this.sanitizeInput(note.locator)}</p>
                        <p><span class="font-semibold">Locatário:</span> ${this.sanitizeInput(note.tenant)}</p>
                        <p><span class="font-semibold">Endereço:</span> ${this.sanitizeInput(note.address)}</p>
                    </div>

                    <div class="col-span-full">
                        <p class="font-semibold mb-2">Problema:</p>
                        <p class="whitespace-pre-wrap bg-gray-50 p-4 rounded-lg">
                            ${this.sanitizeInput(note.problem)}
                        </p>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-wrap gap-2 mb-6">
                    ${this.generateStatusButtons(note.status)}
                    <button id="copyDetailsBtn" class="btn btn-gray">
                        <i class="fas fa-copy mr-2"></i>Copiar Detalhes
                    </button>
                    <button id="downloadContractBtn" class="btn btn-blue">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                    <button id="deleteNoteBtn" class="btn btn-red">
                        <i class="fas fa-trash mr-2"></i>Excluir
                    </button>
                </div>

                <!-- Seção de Agendamento -->
                ${note.status === 'scheduled' ? this.generateSchedulingSection(note) : ''}

                <!-- Seção de Comentários -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold mb-4">Comentários</h3>
                    <form id="commentForm" class="mb-4">
                        <textarea id="commentText" 
                                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-h-[80px]"
                                  placeholder="Adicione um comentário..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button type="submit" class="btn btn-blue">
                                <i class="fas fa-comment mr-2"></i>Comentar
                            </button>
                        </div>
                    </form>
                    <div id="commentsContainer" class="space-y-4">
                        <!-- Comentários serão renderizados aqui -->
                    </div>
                </div>
            </div>
        `;

        // Mostrar modal
        modal.classList.remove('hidden');

        // Configurar event listeners
        this.setupDetailsEventListeners(noteKey);
        this.renderComments(noteKey);
    }

    generateStatusButtons(currentStatus) {
        const buttons = [
            { status: 'open', text: 'Reabrir', icon: 'folder-open', color: 'blue' },
            { status: 'scheduled', text: 'Agendar', icon: 'calendar-alt', color: 'orange' },
            { status: 'closed', text: 'Finalizar', icon: 'check-circle', color: 'green' }
        ];

        return buttons
            .filter(btn => btn.status !== currentStatus)
            .map(btn => `
                <button class="btn btn-${btn.color} status-btn" data-status="${btn.status}">
                    <i class="fas fa-${btn.icon} mr-2"></i>${btn.text}
                </button>
            `).join('');
    }

    generateSchedulingSection(note) {
        return `
            <div id="schedulingContainer" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-3">Informações de Agendamento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Data do Agendamento</label>
                        <input type="date" 
                               id="scheduleDate" 
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                               value="${note.scheduleDate || ''}">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Prestador de Serviço</label>
                        <input type="text" 
                               id="serviceProvider" 
                               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                               value="${note.serviceProvider || ''}"
                               placeholder="Nome do prestador">
                    </div>
                </div>
            </div>
        `;
    }

    setupDetailsEventListeners(noteKey) {
        // ... (continuará na próxima parte)
    }
}
</script>

// Continuação da classe NoteManager
class NoteManager {
    // ... (manter o código anterior da classe) ...

    setupDetailsEventListeners(noteKey) {
        const modal = document.getElementById('noteDetailsModal');
        const note = this.notes[noteKey];

        // Fechar modal
        document.getElementById('closeDetailsBtn')?.addEventListener('click', () => {
            modal.classList.add('hidden');
            this.activeNoteKey = null;
        });

        // Botões de status
        document.querySelectorAll('.status-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.updateNoteStatus(noteKey, btn.dataset.status);
            });
        });

        // Formulário de comentários
        document.getElementById('commentForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addComment(noteKey);
        });

        // Copiar detalhes
        document.getElementById('copyDetailsBtn')?.addEventListener('click', () => {
            this.copyNoteDetails(noteKey);
        });

        // Exportar nota
        document.getElementById('downloadContractBtn')?.addEventListener('click', () => {
            this.exportNote(noteKey);
        });

        // Excluir nota
        document.getElementById('deleteNoteBtn')?.addEventListener('click', () => {
            this.deleteNote(noteKey);
        });

        // Atualizar informações de agendamento
        if (note.status === 'scheduled') {
            const scheduleDate = document.getElementById('scheduleDate');
            const serviceProvider = document.getElementById('serviceProvider');

            const updateScheduling = () => {
                this.updateSchedulingInfo(noteKey, 
                    scheduleDate.value,
                    serviceProvider.value.trim()
                );
            };

            scheduleDate?.addEventListener('change', updateScheduling);
            serviceProvider?.addEventListener('blur', updateScheduling);
        }

        // Fechar com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                this.activeNoteKey = null;
            }
        });
    }

    updateNoteStatus(noteKey, newStatus) {
        const note = this.notes[noteKey];
        if (!note) return;

        const oldStatus = note.status;
        note.status = newStatus;

        switch (newStatus) {
            case 'open':
                note.scheduleDate = null;
                note.serviceProvider = null;
                note.closedAt = null;
                break;

            case 'scheduled':
                note.closedAt = null;
                break;

            case 'closed':
                note.closedAt = new Date().toISOString();
                break;
        }

        this.saveToLocalStorage();
        this.renderNote(noteKey);
        this.showNoteDetails(noteKey);

        const statusMessages = {
            'open': 'Anotação reaberta com sucesso!',
            'scheduled': 'Anotação movida para agendamento!',
            'closed': 'Anotação finalizada com sucesso!'
        };

        utils.showNotification(statusMessages[newStatus], 'success');
    }

    updateSchedulingInfo(noteKey, scheduleDate, serviceProvider) {
        const note = this.notes[noteKey];
        if (!note || note.status !== 'scheduled') return;

        note.scheduleDate = scheduleDate;
        note.serviceProvider = serviceProvider;

        this.saveToLocalStorage();
        this.renderNote(noteKey);

        utils.showNotification('Informações de agendamento atualizadas!', 'success');
    }

    addComment(noteKey) {
        const commentText = document.getElementById('commentText')?.value.trim();
        if (!commentText) {
            utils.showNotification('O comentário não pode estar vazio.', 'error');
            return;
        }

        const note = this.notes[noteKey];
        if (!note.comments) note.comments = [];

        const newComment = {
            id: Date.now().toString(),
            text: commentText,
            dateTime: new Date().toISOString(),
            editedAt: null
        };

        note.comments.push(newComment);
        this.saveToLocalStorage();
        this.renderComments(noteKey);

        document.getElementById('commentForm')?.reset();
        utils.showNotification('Comentário adicionado com sucesso!', 'success');
    }

    renderComments(noteKey) {
        const container = document.getElementById('commentsContainer');
        const note = this.notes[noteKey];
        
        if (!container || !note) return;

        container.innerHTML = '';

        if (!note.comments || note.comments.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    Nenhum comentário ainda. Seja o primeiro a comentar!
                </div>
            `;
            return;
        }

        note.comments.slice().reverse().forEach(comment => {
            const commentElement = this.createCommentElement(comment, noteKey);
            container.appendChild(commentElement);
        });
    }

    createCommentElement(comment, noteKey) {
        const div = document.createElement('div');
        div.className = 'comment-box';
        div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="text-xs text-gray-500">
                    ${utils.formatDate(comment.dateTime, true)}
                    ${comment.editedAt ? ' (editado)' : ''}
                </div>
                <div class="flex space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 edit-comment-btn" 
                            data-comment-id="${comment.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-700 delete-comment-btn" 
                            data-comment-id="${comment.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="comment-text whitespace-pre-wrap">${this.sanitizeInput(comment.text)}</div>
            <div class="edit-form hidden mt-2">
                <textarea class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">${comment.text}</textarea>
                <div class="flex justify-end space-x-2 mt-2">
                    <button class="btn btn-gray cancel-edit-btn">Cancelar</button>
                    <button class="btn btn-blue save-edit-btn">Salvar</button>
                </div>
            </div>
        `;

        this.setupCommentEventListeners(div, noteKey, comment.id);
        return div;
    }

    // ... (continuará na próxima parte)
}
</script>

// Continuação da classe NoteManager
class NoteManager {
    // ... (manter o código anterior da classe) ...

    setupCommentEventListeners(commentElement, noteKey, commentId) {
        // Editar comentário
        commentElement.querySelector('.edit-comment-btn')?.addEventListener('click', () => {
            const editForm = commentElement.querySelector('.edit-form');
            const commentText = commentElement.querySelector('.comment-text');
            editForm.classList.remove('hidden');
            commentText.classList.add('hidden');
        });

        // Cancelar edição
        commentElement.querySelector('.cancel-edit-btn')?.addEventListener('click', () => {
            const editForm = commentElement.querySelector('.edit-form');
            const commentText = commentElement.querySelector('.comment-text');
            editForm.classList.add('hidden');
            commentText.classList.remove('hidden');
        });

        // Salvar edição
        commentElement.querySelector('.save-edit-btn')?.addEventListener('click', () => {
            const newText = commentElement.querySelector('textarea').value.trim();
            if (newText) {
                this.editComment(noteKey, commentId, newText);
            }
        });

        // Excluir comentário
        commentElement.querySelector('.delete-comment-btn')?.addEventListener('click', () => {
            this.deleteComment(noteKey, commentId);
        });
    }

    editComment(noteKey, commentId, newText) {
        const note = this.notes[noteKey];
        const comment = note.comments.find(c => c.id === commentId);
        
        if (comment && newText !== comment.text) {
            comment.text = newText;
            comment.editedAt = new Date().toISOString();
            this.saveToLocalStorage();
            this.renderComments(noteKey);
            utils.showNotification('Comentário atualizado com sucesso!', 'success');
        }
    }

    deleteComment(noteKey, commentId) {
        if (!confirm('Tem certeza que deseja excluir este comentário?')) {
            return;
        }

        const note = this.notes[noteKey];
        const commentIndex = note.comments.findIndex(c => c.id === commentId);
        
        if (commentIndex !== -1) {
            note.comments.splice(commentIndex, 1);
            this.saveToLocalStorage();
            this.renderComments(noteKey);
            utils.showNotification('Comentário excluído com sucesso!', 'success');
        }
    }

    deleteNote(noteKey) {
        if (!confirm('Tem certeza que deseja excluir esta anotação? Esta ação não pode ser desfeita.')) {
            return;
        }

        delete this.notes[noteKey];
        this.saveToLocalStorage();
        
        document.querySelector(`[data-note-key="${noteKey}"]`)?.remove();
        document.getElementById('noteDetailsModal').classList.add('hidden');
        this.activeNoteKey = null;
        
        utils.showNotification('Anotação excluída com sucesso!', 'success');
    }

    exportNote(noteKey) {
        const note = this.notes[noteKey];
        if (!note) return;

        const dataStr = JSON.stringify({ [noteKey]: note }, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `contrato_${note.contractNumber}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        utils.showNotification('Contrato exportado com sucesso!', 'success');
    }

    exportAllNotes() {
        const dataStr = JSON.stringify(this.notes, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `contratos_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        utils.showNotification('Dados exportados com sucesso!', 'success');
    }

    handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                let importCount = 0;
                let skipCount = 0;

                for (const [key, note] of Object.entries(importedData)) {
                    if (this.notes[key]) {
                        skipCount++;
                        continue;
                    }

                    if (this.validateImportedNote(note)) {
                        this.notes[key] = note;
                        this.renderNote(key);
                        importCount++;
                    } else {
                        skipCount++;
                    }
                }

                this.saveToLocalStorage();
                utils.showNotification(
                    `Importação concluída! ${importCount} notas importadas, ${skipCount} ignoradas.`,
                    'success'
                );
            } catch (error) {
                utils.showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
            }
        };

        reader.onerror = () => {
            utils.showNotification('Erro ao ler arquivo.', 'error');
        };

        reader.readAsText(file);
        event.target.value = '';
    }

    validateImportedNote(note) {
        const requiredFields = [
            'contractNumber',
            'locator',
            'tenant',
            'problem',
            'address',
            'createdAt',
            'status'
        ];

        return requiredFields.every(field => 
            note.hasOwnProperty(field) && 
            note[field] !== null && 
            note[field] !== undefined
        ) && ['open', 'scheduled', 'closed'].includes(note.status);
    }

    // Inicialização dos event listeners globais
    initializeEventListeners() {
        // Botão de exportar todos
        document.getElementById('downloadNotesBtn')?.addEventListener('click', () => {
            this.exportAllNotes();
        });

        // Input de importação
        const fileInput = document.getElementById('fileInput');
        document.getElementById('importNotesBtn')?.addEventListener('click', () => {
            fileInput?.click();
        });

        fileInput?.addEventListener('change', (e) => {
            this.handleFileImport(e);
        });

        // Filtros e busca
        ['statusFilter', 'dateSort', 'searchInput'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', () => {
                this.filterAndSortNotes();
            });
        });

        document.getElementById('searchInput')?.addEventListener('input', () => {
            this.filterAndSortNotes();
        });
    }
}

// Inicialização global
document.addEventListener('DOMContentLoaded', () => {
    window.noteManager = new NoteManager();
});
</script>

</body>
</html>
